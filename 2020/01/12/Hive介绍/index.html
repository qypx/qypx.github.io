<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/qypx_robot/apple-touch-icon.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/qypx_robot/favicon-32x32.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/qypx_robot/favicon-16x16.png?v=5.1.4">


  <link rel="mask-icon" href="/images/qypx_robot/safari-pinned-tab.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hadoop,Hive,">










<meta name="keywords" content="Hadoop,Hive">
<meta property="og:type" content="article">
<meta property="og:title" content="Hiveä»‹ç»">
<meta property="og:url" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/index.html">
<meta property="og:site_name" content="qypx ã® blog">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1606383486184.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603599880662.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603599824805.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603600131112.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603600188322.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603609902727.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603610044780.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603610161316.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603610193337.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603610402205.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603600496450.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603600549196.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603609992170.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603610068333.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603610449476.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603610471246.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603610518016.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603610616445.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603610644871.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603613699566.png">
<meta property="og:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1603614353762.png">
<meta property="og:updated_time" content="2022-10-19T04:19:22.540Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hiveä»‹ç»">
<meta name="twitter:image" content="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/1606383486184.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/">





<!-- ç½‘é¡µåŠ è½½æ¡ -->
<script src="https://neveryu.github.io/js/src/pace.min.js"></script>

  <title>Hiveä»‹ç» | qypx ã® blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">qypx ã® blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">æœºä¼šæ˜¯ç•™ç»™æœ‰å‡†å¤‡çš„äººçš„.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            å½’æ¡£
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            æœç´¢
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="æœç´¢..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://qypx.github.io/2020/01/12/Hiveä»‹ç»/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="qypx">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="qypx ã® blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Hiveä»‹ç»</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-01-12T20:26:40+08:00">
                2020-01-12
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">æ›´æ–°äº&#58;</span>
              
              <time title="æ›´æ–°äº" itemprop="dateModified" datetime="2022-10-19T12:19:22+08:00">
                2022-10-19
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">Hadoop</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> é˜…è¯»é‡
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p> å‚è€ƒï¼š<br> <a href="https://blog.csdn.net/PowerBlogger/article/details/83626449" target="_blank" rel="noopener">https://blog.csdn.net/PowerBlogger/article/details/83626449</a><br> <a href="https://blog.csdn.net/u010886217/article/details/83796151" target="_blank" rel="noopener">https://blog.csdn.net/u010886217/article/details/83796151</a><br> ã€ŠHadoopæ„å»ºæ•°æ®ä»“åº“å®è·µã€‹</p>
<p> æ›´å¤šå†…å®¹è§Hiveå®˜æ–¹æ–‡æ¡£<br> <a href="https://cwiki.apache.org/confluence/display/Hive/Home#Home-UserDocumentation" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/Hive/Home#Home-UserDocumentation</a></p>
</blockquote>
<h2 id="1-ä»€ä¹ˆæ˜¯Hiveï¼Ÿ"><a href="#1-ä»€ä¹ˆæ˜¯Hiveï¼Ÿ" class="headerlink" title="1.ä»€ä¹ˆæ˜¯Hiveï¼Ÿ"></a>1.ä»€ä¹ˆæ˜¯Hiveï¼Ÿ</h2><p>Hive æ˜¯ Hadoop ç”Ÿæ€åœˆçš„æ•°æ®ä»“åº“è½¯ä»¶ï¼Œé‡Œé¢æœ‰è¡¨çš„æ¦‚å¿µï¼Œä½¿ç”¨ç±»ä¼¼äº SQL çš„è¯­è¨€ï¼ˆHiveQLï¼‰è¯»ã€å†™ã€ç®¡ç†åˆ†å¸ƒå¼å­˜å‚¨ä¸Šçš„å¤§æ•°æ®é›†ã€‚å®ƒå»ºç«‹åœ¨ Hadoop ä¹‹ä¸Šï¼Œå…·æœ‰ä»¥ä¸‹åŠŸèƒ½å’Œç‰¹ç‚¹ï¼š</p>
<ul>
<li>é€šè¿‡ HiveQL æ–¹ä¾¿åœ°è®¿é—®æ•°æ®ï¼Œ<strong>é€‚åˆæ‰§è¡Œ ETLã€æŠ¥è¡¨æŸ¥è¯¢ã€æ•°æ®åˆ†æç­‰æ•°æ®ä»“åº“ä»»åŠ¡</strong>ã€‚</li>
<li>æä¾›ä¸€ç§æœºåˆ¶ï¼Œç»™å„ç§å„æ ·çš„æ•°æ®æ ¼å¼æ·»åŠ ç»“æ„ã€‚</li>
<li>ç›´æ¥è®¿é—® HDFS çš„æ–‡ä»¶ï¼Œæˆ–è€…è®¿é—®å¦‚ HBase çš„å…¶ä»–æ•°æ®å­˜å‚¨ã€‚</li>
<li>å¯ä»¥é€šè¿‡ MapReduceã€Spark æˆ– Tez ç­‰å¤šç§è®¡ç®—æ¡†æ¶æ‰§è¡ŒæŸ¥è¯¢ã€‚</li>
</ul>
<p>Hive è¢«è®¾è®¡æˆä¸€ä¸ªå¯æ‰©å±•çš„ã€é«˜æ€§èƒ½çš„ã€å®¹é”™çš„ã€ä¸è¾“å…¥æ•°æ®æ ¼å¼æ¾è€¦åˆçš„ç³»ç»Ÿï¼Œ<strong>é€‚åˆäºæ•°æ®ä»“åº“ä¸­çš„æ±‡æ€»ã€åˆ†æã€æ‰¹å¤„ç†æŸ¥è¯¢ç­‰ä»»åŠ¡ï¼Œè€Œä¸é€‚åˆè”æœºäº‹åŠ¡å¤„ç†ï¼ˆOLTPï¼‰çš„å·¥ä½œåœºæ™¯</strong>ã€‚Hive åŒ…æ‹¬ HCatalog å’Œ WebHCat ä¸¤ä¸ªç»„ä»¶ã€‚HCatalog æ˜¯ Hadoop çš„è¡¨å’Œå­˜å‚¨ç®¡ç†å±‚ï¼Œå…è®¸ä½¿ç”¨ Pig å’Œ MapReduce ç­‰æ•°æ®å¤„ç†å·¥å…·çš„ç”¨æˆ·æ›´å®¹æ˜“è¯»å†™é›†ç¾¤ä¸­çš„æ•°æ®ã€‚WebHCat æä¾›äº†ä¸€ä¸ªæœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ HTTP æ¥å£æ‰§è¡Œ MapReduce ï¼ˆæˆ– YARNï¼‰ã€Pigã€Hive ä½œä¸šæˆ–å…ƒæ•°æ®æ“ä½œã€‚</p>
<p>HiveQL åªå¤„ç†ç»“æ„åŒ–æ•°æ®ï¼Œå¹¶ä¸”ä¸åŒºåˆ†å¤§å°å†™ï¼ˆä¸SQLä¸€æ ·ï¼‰ã€‚</p>
<p><span style="color:red">Hive é‡Œçš„æ•°æ®æœ€ç»ˆå­˜å‚¨åœ¨ HDFS çš„æ–‡ä»¶ä¸­</span>ï¼Œå¸¸ç”¨çš„æ•°æ®æ–‡ä»¶æ ¼å¼æœ‰ä»¥ä¸‹4ç§ï¼š<strong>TEXTFILEã€SEQUENCEFILEã€RCFILEã€ORCFILE</strong>ã€‚ï¼ˆå…³äºæ–‡ä»¶æ ¼å¼çš„æ›´è¯¦ç»†å†…å®¹è§ <a href="#jump3.1.2">3.1.2 file format</a>ï¼‰ã€‚åœ¨ Hive ä¸­æ–‡ä»¶æ ¼å¼æŒ‡çš„æ˜¯è®°å½•ä»¥æ€æ ·çš„ç¼–ç æ ¼å¼è¢«å­˜å‚¨åˆ°æ–‡ä»¶ä¸­ã€‚ä¸åŒæ–‡ä»¶æ ¼å¼çš„ä¸»è¦åŒºåˆ«åœ¨äºå®ƒä»¬çš„æ•°æ®ç¼–ç ã€å‹ç¼©ç‡ã€ä½¿ç”¨çš„ç©ºé—´å’Œç£ç›˜I/Oã€‚åœ¨åŠ è½½æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼ŒHiveä¸ä¼šå¯¹æ•°æ®æœ¬èº«è¿›è¡Œä»»ä½•ä¿®æ”¹ï¼Œè€Œåªæ˜¯å°†æ•°æ®å†…å®¹å¤åˆ¶æˆ–è€…ç§»åŠ¨åˆ°ç›¸åº”çš„HDFSç›®å½•ä¸­ã€‚</p>
<p>å½“ç”¨æˆ·å‘ä¼ ç»Ÿæ•°æ®åº“ä¸­å¢åŠ æ•°æ®æ—¶ï¼Œç³»ç»Ÿä¼šæ£€æŸ¥å†™å…¥çš„æ•°æ®ä¸è¡¨ç»“æ„æ˜¯å¦åŒ¹é…ï¼Œå¦‚æœä¸åŒ¹é…åˆ™æ‹’ç»æ’å…¥æ•°æ®ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„<strong>å†™æ—¶æ¨¡å¼</strong>ã€‚Hiveä¸æ­¤ä¸åŒï¼Œå®ƒä½¿ç”¨çš„æ˜¯<strong>è¯»æ—¶æ¨¡å¼</strong>ï¼Œå³ç›´åˆ°è¯»å–æ—¶å†è¿›è¡Œæ•°æ®æ ¡éªŒï¼ˆåŠ è½½æ•°æ®æ—¶ä¸è¿›è¡Œæ•°æ®æ ¼å¼çš„æ ¡éªŒï¼Œè¯»å–æ•°æ®æ—¶å¦‚æœä¸åˆæ³•åˆ™æ˜¾ç¤ºNULLã€‚è¿™ç§æ¨¡å¼çš„ä¼˜ç‚¹åœ¨äºåŠ è½½æ•°æ®è¿…é€Ÿï¼‰ã€‚åœ¨å‘ Hive è£…è½½æ•°æ®æ—¶ï¼Œå®ƒå¹¶ä¸éªŒè¯æ•°æ®ä¸è¡¨ç»“æ„æ˜¯å¦åŒ¹é…ï¼Œä½†è¿™æ—¶å®ƒä¼šæ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦å’Œè¡¨å®šä¹‰ç›¸åŒ¹é…ã€‚</p>
<h2 id="2-Hiveçš„åŸç†"><a href="#2-Hiveçš„åŸç†" class="headerlink" title="2.Hiveçš„åŸç†"></a>2.Hiveçš„åŸç†</h2><p><strong>Hive å°†ç”¨æˆ·çš„ HiveQL è¯­å¥è¿›è¡Œè§£æï¼Œä¼˜åŒ–ï¼Œæœ€ç»ˆæŠŠä¸€ä¸ªä¸ªçš„HiveQLè¯­å¥è½¬æ¢ä¸º MapReduce ä½œä¸šæäº¤åˆ° Hadoop é›†ç¾¤ä¸Šï¼ŒHadoopè¿›è¡Œä½œä¸šçš„è°ƒåº¦åŠç›‘æ§ï¼Œä½œä¸šå®Œæˆåå°†æ‰§è¡Œç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚</strong>æ‰€ä»¥ï¼Œ<strong>Hiveå¹¶ä¸è¿›è¡Œè®¡ç®—ï¼Œåªæ˜¯æŠŠHiveQLè§£æä¸ºMapperReduceåœ¨HDFSé›†ç¾¤ä¸­è¿è¡Œè€Œå·²</strong>ï¼Œæ‰€ä»¥Hiveçš„æ•ˆç‡å¹¶ä¸é«˜ã€‚</p>
<h3 id="2-1-Hive-çš„ä½“ç³»ç»“æ„"><a href="#2-1-Hive-çš„ä½“ç³»ç»“æ„" class="headerlink" title="2.1 Hive çš„ä½“ç³»ç»“æ„"></a>2.1 Hive çš„ä½“ç³»ç»“æ„</h3><p>Hive çš„ä½“ç³»ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/2020/01/12/Hiveä»‹ç»/1606383486184.png" alt="1606383486184"></p>
<p>Hiveå»ºç«‹åœ¨ Hadoop çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ HDFS å’Œ MapReduce ä¹‹ä¸Šã€‚ä¸Šå›¾æ˜¾ç¤ºäº† Hadoop1 å’Œ Hadoop2 ä¸­çš„ä¸¤ç§ MapReduce ç»„ä»¶ã€‚</p>
<p>åœ¨ HDFS å’Œ MapReduce ä¹‹ä¸Šï¼Œå›¾ä¸­æ˜¾ç¤ºäº† Hive é©±åŠ¨ç¨‹åºå’Œå…ƒæ•°æ®å­˜å‚¨ã€‚Hive é©±åŠ¨ç¨‹åºåŠå…¶ç¼–è¯‘å™¨è´Ÿè´£ç¼–è¯‘ã€ä¼˜åŒ–å’Œæ‰§è¡Œ HiveQLã€‚ä¾èµ–äºå…·ä½“æƒ…å†µï¼ŒHive é©±åŠ¨ç¨‹åºå¯èƒ½é€‰æ‹©åœ¨æœ¬åœ°æ‰§è¡Œ Hive è¯­å¥æˆ–å‘½ä»¤ï¼Œä¹Ÿå¯èƒ½æ˜¯äº§ç”Ÿä¸€ä¸ª MapReduce ä½œä¸šã€‚Hive é©±åŠ¨ç¨‹åºæŠŠå…ƒæ•°æ®å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚</p>
<p>é»˜è®¤é…ç½®ä¸‹ï¼ŒHive åœ¨å†…å»ºçš„ Derby å…³ç³»æ•°æ®åº“ç³»ç»Ÿä¸­å­˜å‚¨å…ƒæ•°æ®ï¼Œè¿™ç§æ–¹å¼è¢«ç§°ä¸ºåµŒå…¥æ¨¡å¼ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒHive é©±åŠ¨ç¨‹åºã€å…ƒæ•°æ®å’Œ Derby å…¨éƒ¨è¿è¡Œåœ¨åŒä¸€ä¸ª Java è™šæ‹Ÿæœºä¸­ï¼ˆJVMï¼‰ã€‚å®ƒåªæ”¯æŒå•ä¸€ Hive ä¼šè¯ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨äºå¤šç”¨æˆ·çš„ç”Ÿäº§ç¯å¢ƒã€‚Hive è¿˜å…è®¸å°†å…ƒæ•°æ®å­˜å‚¨äºæœ¬åœ°æˆ–è¿œç¨‹çš„å¤–éƒ¨æ•°æ®åº“ä¸­ï¼Œè¿™ç§è®¾ç½®å¯ä»¥æ›´å¥½åœ°æ”¯æŒ Hive çš„å¤šä¼šè¯ç”Ÿäº§ç¯å¢ƒã€‚å¹¶ä¸”ï¼Œå¯ä»¥é…ç½®ä»»ä½•ä¸ JDBC API å…¼å®¹çš„å…³ç³»æ•°æ®åº“ç³»ç»Ÿå­˜å‚¨å…ƒæ•°æ®ï¼Œå¦‚ MySQLã€Oracle ç­‰ã€‚ï¼ˆå…ƒæ•°æ®é»˜è®¤å­˜å‚¨åœ¨Hiveè‡ªå¸¦çš„Derbyæ•°æ®åº“ä¸­ï¼Œä½†ç”±äºDerbyä¸èƒ½å®ç°å¹¶å‘è®¿é—®ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨ MySQL è¿›è¡Œæ›¿æ¢ï¼‰ã€‚</p>
<p>å¯¹åº”ç”¨æ”¯æŒçš„å…³é”®ç»„ä»¶æ˜¯ Hive Thrift æœåŠ¡ã€‚ä»»ä½•ä¸ JDBC å…¼å®¹çš„åº”ç”¨ï¼Œéƒ½å¯ä»¥é€šè¿‡ç»‘å®šçš„ JDBC é©±åŠ¨è®¿é—® Hiveã€‚ä¸ ODBC å…¼å®¹çš„å®¢æˆ·ç«¯ï¼Œå¦‚ Linux ä¸‹å…¸å‹çš„ unixODBC å’Œ isql åº”ç”¨ç¨‹åºï¼Œå¯ä»¥ä»è¿œç¨‹ Linux å®¢æˆ·ç«¯è®¿é—® Hiveã€‚</p>
<p>æ¶æ„å›¾çš„æœ€ä¸Šé¢åŒ…æ‹¬ä¸€ä¸ªå‘½ä»¤è¡Œæ¥å£ï¼ˆCLIï¼‰ï¼Œå¯ä»¥åœ¨ Linux ç»ˆç«¯çª—å£å‘ Hive é©±åŠ¨ç¨‹åºç›´æ¥å‘å‡ºæŸ¥è¯¢æˆ–ç®¡ç†å‘½ä»¤ã€‚è¿˜æœ‰ä¸€ä¸ªç®€å•çš„ Web ç•Œé¢ï¼Œé€šè¿‡å®ƒå¯ä»¥ä»æµè§ˆå™¨è®¿é—® Hive ç®¡ç†è¡¨åŠå…¶æ•°æ®ã€‚</p>
<h2 id="3-Hiveå»ºè¡¨è¯­å¥"><a href="#3-Hiveå»ºè¡¨è¯­å¥" class="headerlink" title="3.Hiveå»ºè¡¨è¯­å¥"></a><span id="jump3">3.Hiveå»ºè¡¨è¯­å¥</span></h2><blockquote>
<p>å‚è€ƒ<br><a href="https://blog.csdn.net/qq_36743482/article/details/78383964" target="_blank" rel="noopener">https://blog.csdn.net/qq_36743482/article/details/78383964</a><br><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL</a></p>
</blockquote>
<p>Hiveå»ºè¡¨æ–¹å¼å…±æœ‰ä¸‰ç§ï¼š</p>
<ul>
<li>ç›´æ¥å»ºè¡¨æ³•</li>
<li>æŸ¥è¯¢å»ºè¡¨æ³•</li>
<li>likeå»ºè¡¨æ³•</li>
</ul>
<h3 id="3-1-æ³•ä¸€ï¼šç›´æ¥å»ºè¡¨æ³•"><a href="#3-1-æ³•ä¸€ï¼šç›´æ¥å»ºè¡¨æ³•" class="headerlink" title="3.1 æ³•ä¸€ï¼šç›´æ¥å»ºè¡¨æ³•"></a>3.1 æ³•ä¸€ï¼šç›´æ¥å»ºè¡¨æ³•</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> table_name(col_name data_type);</span><br></pre></td></tr></table></figure>
<p>å®Œæ•´çš„syntax:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">CREATE [TEMPORARY] [EXTERNAL] TABLE [IF NOT EXISTS] [db_name.]table_name    -- (Note: TEMPORARY available in Hive 0.14.0 and later)</span><br><span class="line">  [(col_name data_type [column_constraint_specification] [COMMENT col_comment], ... [constraint_specification])]</span><br><span class="line">  [COMMENT table_comment]</span><br><span class="line">  [PARTITIONED BY (col_name data_type [COMMENT col_comment], ...)]</span><br><span class="line">  [CLUSTERED BY (col_name, col_name, ...) [SORTED BY (col_name [ASC|DESC], ...)] INTO num_buckets BUCKETS]</span><br><span class="line">  [SKEWED BY (col_name, col_name, ...)                  -- (Note: Available in Hive 0.10.0 and later)]</span><br><span class="line">     ON ((col_value, col_value, ...), (col_value, col_value, ...), ...)</span><br><span class="line">     [STORED AS DIRECTORIES]</span><br><span class="line">  [</span><br><span class="line">   [ROW FORMAT row_format] </span><br><span class="line">   [STORED AS file_format]</span><br><span class="line">     | STORED BY &apos;storage.handler.class.name&apos; [WITH SERDEPROPERTIES (...)]  -- (Note: Available in Hive 0.6.0 and later)</span><br><span class="line">  ]</span><br><span class="line">  [LOCATION hdfs_path]</span><br><span class="line">  [TBLPROPERTIES (property_name=property_value, ...)]   -- (Note: Available in Hive 0.6.0 and later)</span><br><span class="line">  [AS select_statement];   -- (Note: Available in Hive 0.5.0 and later; not supported for external tables)</span><br><span class="line"> </span><br><span class="line">CREATE [TEMPORARY] [EXTERNAL] TABLE [IF NOT EXISTS] [db_name.]table_name</span><br><span class="line">  LIKE existing_table_or_view_name</span><br><span class="line">  [LOCATION hdfs_path];</span><br><span class="line"> </span><br><span class="line">data_type</span><br><span class="line">  : primitive_type</span><br><span class="line">  | array_type</span><br><span class="line">  | map_type</span><br><span class="line">  | struct_type</span><br><span class="line">  | union_type  -- (Note: Available in Hive 0.7.0 and later)</span><br><span class="line"> </span><br><span class="line">primitive_type</span><br><span class="line">  : TINYINT</span><br><span class="line">  | SMALLINT</span><br><span class="line">  | INT</span><br><span class="line">  | BIGINT</span><br><span class="line">  | BOOLEAN</span><br><span class="line">  | FLOAT</span><br><span class="line">  | DOUBLE</span><br><span class="line">  | DOUBLE PRECISION -- (Note: Available in Hive 2.2.0 and later)</span><br><span class="line">  | STRING</span><br><span class="line">  | BINARY      -- (Note: Available in Hive 0.8.0 and later)</span><br><span class="line">  | TIMESTAMP   -- (Note: Available in Hive 0.8.0 and later)</span><br><span class="line">  | DECIMAL     -- (Note: Available in Hive 0.11.0 and later)</span><br><span class="line">  | DECIMAL(precision, scale)  -- (Note: Available in Hive 0.13.0 and later)</span><br><span class="line">  | DATE        -- (Note: Available in Hive 0.12.0 and later)</span><br><span class="line">  | VARCHAR     -- (Note: Available in Hive 0.12.0 and later)</span><br><span class="line">  | CHAR        -- (Note: Available in Hive 0.13.0 and later)</span><br><span class="line"> </span><br><span class="line">array_type</span><br><span class="line">  : ARRAY &lt; data_type &gt;</span><br><span class="line"> </span><br><span class="line">map_type</span><br><span class="line">  : MAP &lt; primitive_type, data_type &gt;</span><br><span class="line"> </span><br><span class="line">struct_type</span><br><span class="line">  : STRUCT &lt; col_name : data_type [COMMENT col_comment], ...&gt;</span><br><span class="line"> </span><br><span class="line">union_type</span><br><span class="line">   : UNIONTYPE &lt; data_type, data_type, ... &gt;  -- (Note: Available in Hive 0.7.0 and later)</span><br><span class="line"> </span><br><span class="line">row_format</span><br><span class="line">  : DELIMITED [FIELDS TERMINATED BY char [ESCAPED BY char]] [COLLECTION ITEMS TERMINATED BY char]</span><br><span class="line">        [MAP KEYS TERMINATED BY char] [LINES TERMINATED BY char]</span><br><span class="line">        [NULL DEFINED AS char]   -- (Note: Available in Hive 0.13 and later)</span><br><span class="line">  | SERDE serde_name [WITH SERDEPROPERTIES (property_name=property_value, property_name=property_value, ...)]</span><br><span class="line"> </span><br><span class="line">file_format:</span><br><span class="line">  : SEQUENCEFILE</span><br><span class="line">  | TEXTFILE    -- (Default, depending on hive.default.fileformat configuration)</span><br><span class="line">  | RCFILE      -- (Note: Available in Hive 0.6.0 and later)</span><br><span class="line">  | ORC         -- (Note: Available in Hive 0.11.0 and later)</span><br><span class="line">  | PARQUET     -- (Note: Available in Hive 0.13.0 and later)</span><br><span class="line">  | AVRO        -- (Note: Available in Hive 0.14.0 and later)</span><br><span class="line">  | JSONFILE    -- (Note: Available in Hive 4.0.0 and later)</span><br><span class="line">  | INPUTFORMAT input_format_classname OUTPUTFORMAT output_format_classname</span><br><span class="line"> </span><br><span class="line">column_constraint_specification:</span><br><span class="line">  : [ PRIMARY KEY|UNIQUE|NOT NULL|DEFAULT [default_value]|CHECK  [check_expression] ENABLE|DISABLE NOVALIDATE RELY/NORELY ]</span><br><span class="line"> </span><br><span class="line">default_value:</span><br><span class="line">  : [ LITERAL|CURRENT_USER()|CURRENT_DATE()|CURRENT_TIMESTAMP()|NULL ] </span><br><span class="line"> </span><br><span class="line">constraint_specification:</span><br><span class="line">  : [, PRIMARY KEY (col_name, ...) DISABLE NOVALIDATE RELY/NORELY ]</span><br><span class="line">    [, PRIMARY KEY (col_name, ...) DISABLE NOVALIDATE RELY/NORELY ]</span><br><span class="line">    [, CONSTRAINT constraint_name FOREIGN KEY (col_name, ...) REFERENCES table_name(col_name, ...) DISABLE NOVALIDATE </span><br><span class="line">    [, CONSTRAINT constraint_name UNIQUE (col_name, ...) DISABLE NOVALIDATE RELY/NORELY ]</span><br><span class="line">    [, CONSTRAINT constraint_name CHECK [check_expression] ENABLE|DISABLE NOVALIDATE RELY/NORELY ]</span><br></pre></td></tr></table></figure>
<p>(ğŸ‘†æ¥è‡ªå®˜ç½‘ <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL</a><br>[] è¡¨ç¤ºå¯é€‰ï¼Œ| è¡¨ç¤ºé€‰å…¶ä¸€)</p>
<p>æ³¨ï¼š</p>
<ul>
<li>ä¸ä½¿ç”¨ EXTERNAL æ—¶ï¼Œåˆ›å»ºçš„æ˜¯å†…éƒ¨è¡¨ã€‚</li>
<li>è¡¨å’Œåˆ—çš„æ³¨é‡Šï¼ˆCOMMENTï¼‰æ˜¯å­—ç¬¦ä¸²æ–‡å­—(å•å¼•å·)ã€‚</li>
<li>è¦ä¸ºè¡¨æŒ‡å®šä¸€ä¸ªæ•°æ®åº“ï¼Œè¦ä¹ˆåœ¨<code>CREATE TABLE</code>è¯­å¥ä¹‹å‰ä½¿ç”¨<code>USE database_name</code>è¯­å¥ï¼Œè¦ä¹ˆç”¨ä¸€ä¸ªæ•°æ®åº“åç§°é™å®šè¡¨å(<code>database_name.table_name</code>)ã€‚</li>
<li>See <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-AlterTable" target="_blank" rel="noopener">Alter Table</a> for more information about table comments, table properties, and SerDe properties.</li>
<li>See <a href="https://cwiki.apache.org/confluence/display/Hive/Tutorial#Tutorial-TypeSystem" target="_blank" rel="noopener">Type System</a> and <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Types" target="_blank" rel="noopener">Hive Data Types</a> for details about the primitive and complex data types.</li>
</ul>
<p>è¿™é‡Œæˆ‘ä»¬é’ˆå¯¹é‡Œé¢çš„ä¸€äº›ä¸åŒäºå…³ç³»å‹æ•°æ®åº“çš„åœ°æ–¹è¿›è¡Œè¯´æ˜ã€‚</p>
<h4 id="3-1-1-row-format"><a href="#3-1-1-row-format" class="headerlink" title="3.1.1 row format"></a><span id="jump3.1.1">3.1.1 row format</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ROW FORMAT DELIMITED [FIELDS TERMINATED BY char [ESCAPED BY char]] [COLLECTION ITEMS TERMINATED BY char]</span><br><span class="line">[MAP KEYS TERMINATED BY char] [LINES TERMINATED BY char]</span><br><span class="line">[NULL DEFINED AS char]   -- (Note: Available in Hive 0.13 and later)</span><br><span class="line">| SERDE serde_name [WITH SERDEPROPERTIES (property_name=property_value, property_name=property_value, ...)]</span><br></pre></td></tr></table></figure>
<p>Hiveå°†HDFSä¸Šçš„æ–‡ä»¶æ˜ å°„æˆè¡¨ç»“æ„ï¼Œé€šè¿‡åˆ†éš”ç¬¦æ¥åŒºåˆ†åˆ—ï¼ˆæ¯”å¦‚â€˜,â€™, â€˜;â€™ or â€˜^â€™ç­‰ï¼‰ï¼Œrow formatå°±æ˜¯ç”¨äºæŒ‡å®šåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è§„åˆ™ã€‚<br>æ¯”å¦‚å¯¹äºä»¥ä¸‹è®°å½•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1,xiaoming,book-TV-code,beijing:chaoyang-shagnhai:pudong</span><br><span class="line">2,lilei,book-code,nanjing:jiangning-taiwan:taibei</span><br><span class="line">3,lihua,music-book,heilongjiang:haerbin</span><br></pre></td></tr></table></figure>
<p><strong>é€—å·</strong>ç”¨äºåˆ†å‰²åˆ—ï¼Œå³FIELDS TERMINATED BY â€˜,â€™ï¼Œåˆ†å‰²ä¸ºå¦‚ä¸‹åˆ— <strong>ID</strong>ã€<strong>name</strong>ã€<strong>hobby</strong>ï¼ˆè¯¥å­—æ®µæ˜¯æ•°ç»„å½¢å¼ï¼Œé€šè¿‡ â€˜-â€™ è¿›è¡Œåˆ†å‰²ï¼Œå³COLLECTION ITEMS TERMINATED BY â€˜-â€™ï¼‰ã€<strong>address</strong>ï¼ˆè¯¥å­—æ®µæ˜¯é”®å€¼å¯¹å½¢å¼mapï¼Œé€šè¿‡ â€˜:â€™ åˆ†å‰²é”®å€¼ï¼Œå³ MAP KEYS TERMINATED BY â€˜:â€™ï¼‰ï¼›<br>è€Œ LINES TERMINATED BY char ç”¨äºåŒºåˆ†ä¸åŒæ¡çš„æ•°æ®ï¼Œé»˜è®¤æ˜¯æ¢è¡Œç¬¦ï¼›</p>
<p>å†™æ³•å½¢å¦‚ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> xxx(</span><br><span class="line">	...</span><br><span class="line">)</span><br><span class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> <span class="keyword">DELIMITED</span> </span><br><span class="line">FILEDS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span> </span><br><span class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'-'</span> </span><br><span class="line"><span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">':'</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>
<p>(â†‘æœªæµ‹è¯•)</p>
<h4 id="3-1-2-file-formatï¼ˆHDFSæ–‡ä»¶å­˜æ”¾çš„æ ¼å¼ï¼‰"><a href="#3-1-2-file-formatï¼ˆHDFSæ–‡ä»¶å­˜æ”¾çš„æ ¼å¼ï¼‰" class="headerlink" title="3.1.2 file formatï¼ˆHDFSæ–‡ä»¶å­˜æ”¾çš„æ ¼å¼ï¼‰"></a><span id="jump3.1.2">3.1.2 file formatï¼ˆHDFSæ–‡ä»¶å­˜æ”¾çš„æ ¼å¼ï¼‰</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">file_format:</span><br><span class="line">  : SEQUENCEFILE</span><br><span class="line">  | TEXTFILE    -- (Default, depending on hive.default.fileformat configuration)</span><br><span class="line">  | RCFILE      -- (Note: Available in Hive 0.6.0 and later)</span><br><span class="line">  | ORC         -- (Note: Available in Hive 0.11.0 and later)</span><br><span class="line">  | PARQUET     -- (Note: Available in Hive 0.13.0 and later)</span><br><span class="line">  | AVRO        -- (Note: Available in Hive 0.14.0 and later)</span><br><span class="line">  | JSONFILE    -- (Note: Available in Hive 4.0.0 and later)</span><br><span class="line">  | INPUTFORMAT input_format_classname OUTPUTFORMAT output_format_classname</span><br></pre></td></tr></table></figure>
<p>é»˜è®¤TEXTFILEï¼Œå³æ–‡æœ¬æ ¼å¼ï¼Œå¯ä»¥ç›´æ¥æ‰“å¼€ã€‚</p>
<h6 id="3-1-2-1-TEXTFILE"><a href="#3-1-2-1-TEXTFILE" class="headerlink" title="3.1.2.1 TEXTFILE"></a>3.1.2.1 TEXTFILE</h6><p>TEXTFILEå°±æ˜¯æ™®é€šçš„æ–‡æœ¬å‹æ–‡ä»¶ï¼Œæ˜¯ Hadoop é‡Œæœ€å¸¸ç”¨çš„è¾“å…¥è¾“å‡ºæ ¼å¼ï¼Œä¹Ÿæ˜¯ Hive çš„é»˜è®¤æ–‡ä»¶æ ¼å¼ã€‚å¦‚æœè¡¨å®šä¹‰ä¸ºTEXTFILEï¼Œåˆ™å¯ä»¥å‘è¯¥è¡¨ä¸­è£…è½½ä»¥é€—å·ã€TABæˆ–ç©ºæ ¼ä½œä¸ºåˆ†éš”ç¬¦çš„æ•°æ®ï¼Œä¹Ÿå¯ä»¥å¯¼å…¥JSONæ ¼å¼çš„æ•°æ®ã€‚<br>æ–‡æœ¬æ–‡ä»¶ä¸­é™¤äº†å¯ä»¥åŒ…å«æ™®é€šçš„å­—ç¬¦ä¸²ã€æ•°å­—ã€æ—¥æœŸç­‰ç®€å•æ•°æ®ç±»å‹å¤–ï¼Œè¿˜å¯ä»¥åŒ…å«å¤æ‚çš„é›†åˆæ•°æ®ç±»å‹ã€‚Hive æ”¯æŒ <strong>STRUCT</strong>ã€<strong>MAP</strong> å’Œ <strong>ARRAY</strong> ä¸‰ç§é›†åˆæ•°æ®ç±»å‹ã€‚</p>
<h6 id="ç¤ºä¾‹1ï¼šä»¥TABä¸ºåˆ—é—´åˆ†éš”ç¬¦çš„æ–‡æœ¬æ–‡ä»¶"><a href="#ç¤ºä¾‹1ï¼šä»¥TABä¸ºåˆ—é—´åˆ†éš”ç¬¦çš„æ–‡æœ¬æ–‡ä»¶" class="headerlink" title="ç¤ºä¾‹1ï¼šä»¥TABä¸ºåˆ—é—´åˆ†éš”ç¬¦çš„æ–‡æœ¬æ–‡ä»¶"></a><span style="color:blue">ç¤ºä¾‹1ï¼šä»¥TABä¸ºåˆ—é—´åˆ†éš”ç¬¦çš„æ–‡æœ¬æ–‡ä»¶</span></h6><p>åˆ›å»ºä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶/root/data.csvï¼Œå½•å…¥å››åˆ—ä¸¤è¡Œæ•°æ®ï¼Œåˆ—ä¹‹é—´ç”¨TABç¬¦å·ä½œä¸ºåˆ†éš”ç¬¦ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a1	1	b1	c1</span><br><span class="line">a2	2	b2	c2</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œä¸‹é¢çš„è¯­å¥åˆ›å»ºè¡¨ã€è£…è½½æ•°æ®ã€æŸ¥è¯¢è¡¨ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å»ºç«‹TEXTFILEæ ¼å¼çš„è¡¨</span></span><br><span class="line"><span class="keyword">use</span> <span class="keyword">test</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_textfile(</span><br><span class="line">    c1 <span class="keyword">string</span>, </span><br><span class="line">    c2 <span class="built_in">int</span>, </span><br><span class="line">    c3 <span class="keyword">string</span>, </span><br><span class="line">    c4 <span class="keyword">string</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span> </span><br><span class="line"><span class="keyword">stored</span> <span class="keyword">as</span> textfile;</span><br><span class="line"><span class="comment">-- å‘è¡¨ä¸­å¯¼å…¥æ•°æ®</span></span><br><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'root/data.csv'</span> <span class="keyword">into</span> <span class="keyword">table</span> t_textfile;</span><br><span class="line"><span class="comment">-- æŸ¥è¯¢è¡¨</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t_textfile;</span><br></pre></td></tr></table></figure>
<p>æŸ¥è¯¢ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; select * from t_textfile;</span><br><span class="line">OK</span><br><span class="line">a1	1	b1	c1</span><br><span class="line">a2	2	b2	c2</span><br><span class="line">Time taken: 0.493 seconds, Fetched: 2 row(s)</span><br></pre></td></tr></table></figure>
<h6 id="ç¤ºä¾‹2ï¼šJSONæ ¼å¼çš„æ•°æ®æ–‡ä»¶"><a href="#ç¤ºä¾‹2ï¼šJSONæ ¼å¼çš„æ•°æ®æ–‡ä»¶" class="headerlink" title="ç¤ºä¾‹2ï¼šJSONæ ¼å¼çš„æ•°æ®æ–‡ä»¶"></a><span style="color:blue">ç¤ºä¾‹2ï¼šJSONæ ¼å¼çš„æ•°æ®æ–‡ä»¶</span></h6><p>å»ºç«‹ä¸€ä¸ªjsonæ–‡ä»¶/root/simple.jsonï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;foo&quot;:&quot;abc&quot;, &quot;bar&quot;:&quot;2009101100000&quot;, &quot;quux&quot;:&#123;&quot;quuxid&quot;:1234, &quot;quuxname&quot;:&quot;sam&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œä¸‹é¢çš„è¯­å¥åˆ›å»ºè¡¨ã€è£…è½½æ•°æ®ã€æŸ¥è¯¢è¡¨ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- æ ¹æ®å®é™…ç›®å½•æ·»åŠ hive-hcatalog-core.jaråŒ…</span></span><br><span class="line">add jar /opt/cloudera/parcels/CDH-5.7.0-1.cdh5.7.0.p0.45/lib/oozie/libtools/hive-hcatalog-core.jar;</span><br><span class="line"><span class="comment">-- å»ºç«‹æµ‹è¯•è¡¨</span></span><br><span class="line"><span class="keyword">use</span> <span class="keyword">test</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> my_table(</span><br><span class="line">	foo <span class="keyword">string</span>,</span><br><span class="line">	bar <span class="keyword">string</span>,</span><br><span class="line">	quux <span class="keyword">struct</span>&lt;quuxid:<span class="built_in">int</span>, quuxname:<span class="keyword">string</span>&gt;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> serde <span class="string">'org.apache.hive.hcatalog.data.JsonSerDe'</span></span><br><span class="line"><span class="keyword">stored</span> <span class="keyword">as</span> textfile;</span><br><span class="line"><span class="comment">-- è£…è½½æ•°æ®</span></span><br><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/root/simple.json'</span> <span class="keyword">into</span> <span class="keyword">table</span> my_table;</span><br><span class="line"><span class="comment">-- æŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">select</span> foo, bar, quux.quuxid, quux.quuxname <span class="keyword">from</span> my_table;</span><br></pre></td></tr></table></figure>
<p>æŸ¥è¯¢ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OK</span><br><span class="line">abc	2009101100000	1234	sam</span><br><span class="line">Time taken: 22.051 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>
<h6 id="ç¤ºä¾‹3ï¼šcomplex-jsonè¡¨ä¸­å«æœ‰ç»“æ„ç±»å‹åµŒå¥—å’Œç»“æ„ã€æ•°ç»„ã€ç»“æ„ä¸‰å±‚åµŒå¥—ã€‚"><a href="#ç¤ºä¾‹3ï¼šcomplex-jsonè¡¨ä¸­å«æœ‰ç»“æ„ç±»å‹åµŒå¥—å’Œç»“æ„ã€æ•°ç»„ã€ç»“æ„ä¸‰å±‚åµŒå¥—ã€‚" class="headerlink" title="ç¤ºä¾‹3ï¼šcomplex_jsonè¡¨ä¸­å«æœ‰ç»“æ„ç±»å‹åµŒå¥—å’Œç»“æ„ã€æ•°ç»„ã€ç»“æ„ä¸‰å±‚åµŒå¥—ã€‚"></a><span style="color:blue">ç¤ºä¾‹3ï¼šcomplex_jsonè¡¨ä¸­å«æœ‰ç»“æ„ç±»å‹åµŒå¥—å’Œç»“æ„ã€æ•°ç»„ã€ç»“æ„ä¸‰å±‚åµŒå¥—ã€‚</span></h6><p>å»ºç«‹ä¸€ä¸ªjsonæ–‡ä»¶/root/complex.jsonï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;docid&quot;:&quot;abc&quot;, &quot;user&quot;:</span><br><span class="line">	&#123;&quot;id&quot;:1234, &quot;username&quot;:&quot;sam1234&quot;, &quot;name&quot;:&quot;sam&quot;,	&quot;shippingaddress&quot;:</span><br><span class="line">		&#123;&quot;address1&quot;:&quot;123 main st.&quot;, &quot;address2&quot;:&quot;&quot;, &quot;city&quot;:&quot;durham&quot;, &quot;state&quot;:&quot;nc&quot;&#125;, </span><br><span class="line">	&quot;orders&quot;:[&#123;&quot;itemid&quot;:6789, &quot;orderdate&quot;:&quot;11/11/2012&quot;&#125;,&#123;&quot;itemid&quot;:4352, &quot;orderdate&quot;:&quot;12/12/2012&quot;&#125;]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œä¸‹é¢çš„è¯­å¥åˆ›å»ºè¡¨ã€è£…è½½æ•°æ®ã€æŸ¥è¯¢è¡¨ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å»ºç«‹æµ‹è¯•è¡¨</span></span><br><span class="line"><span class="keyword">use</span> <span class="keyword">test</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> complex_json(</span><br><span class="line">	docid <span class="keyword">string</span>,</span><br><span class="line">	<span class="keyword">user</span> <span class="keyword">struct</span>&lt;<span class="keyword">id</span>: <span class="built_in">int</span>,</span><br><span class="line">				username: <span class="keyword">string</span>,</span><br><span class="line">				<span class="keyword">name</span>:	<span class="keyword">string</span>,</span><br><span class="line">				shippingaddress: strcuct&lt;address1: <span class="keyword">string</span>,</span><br><span class="line">										 address2: <span class="keyword">string</span>,</span><br><span class="line">										 city: <span class="keyword">string</span>,</span><br><span class="line">										 state: <span class="keyword">string</span>&gt;,</span><br><span class="line">				orders: <span class="built_in">array</span>&lt;<span class="keyword">struct</span>&lt;itemid:<span class="built_in">int</span>,</span><br><span class="line">									 oderdatate:<span class="keyword">string</span>&gt;&gt;</span><br><span class="line">    			&gt;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> serde <span class="string">'org.apache.hive.hcatalog.data.JsonSerDe'</span></span><br><span class="line"><span class="keyword">stored</span> <span class="keyword">as</span> textfile;</span><br><span class="line"><span class="comment">-- è£…è½½æ•°æ®</span></span><br><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/root/complex.json'</span> overwrite <span class="keyword">into</span> <span class="keyword">table</span> complex_json;</span><br><span class="line"><span class="comment">-- æŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">select</span> docid, user.id, user.shipping address.city <span class="keyword">as</span> city,</span><br><span class="line">	user.orders[<span class="number">0</span>].itemid <span class="keyword">as</span> order0id,</span><br><span class="line">	user.orders[<span class="number">1</span>].itemid <span class="keyword">as</span> order1id</span><br><span class="line"><span class="keyword">from</span> complex_json;</span><br></pre></td></tr></table></figure>
<p>æŸ¥è¯¢ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OK</span><br><span class="line">abc	1234	durham	6789	4352</span><br><span class="line">Time taken: 18.744 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>
<p>æŸ¥è¯¢ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> docid, user.id, user.orders.itemid <span class="keyword">from</span> complex_json;</span><br></pre></td></tr></table></figure>
<p>æŸ¥è¯¢ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OK</span><br><span class="line">abc	1234	[6789,4352]</span><br><span class="line">Time taken: 17.755 seconds, Fetched: 1 row(s)</span><br></pre></td></tr></table></figure>
<h6 id="3-1-2-2-SEQUENCEFILE"><a href="#3-1-2-2-SEQUENCEFILE" class="headerlink" title="3.1.2.2  SEQUENCEFILE"></a>3.1.2.2  SEQUENCEFILE</h6><p>Hadoopå¤„ç†å°‘é‡å¤§æ–‡ä»¶æ¯”å¤§é‡å°æ–‡ä»¶çš„æ€§èƒ½è¦å¥½ã€‚å¦‚æœæ–‡ä»¶å°äºHadoopå®šä¹‰çš„å—å°ºå¯¸ï¼ˆHadoop 2.xé»˜è®¤æ˜¯128MBï¼‰ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯å°æ–‡ä»¶ã€‚å…ƒæ•°æ®çš„å¢é•¿å°†è½¬åŒ–ä¸ºNameNodeçš„å¼€é”€ã€‚å¦‚æœæœ‰å¤§é‡å°æ–‡ä»¶ï¼ŒNameNodeä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒHadoopå¼•å…¥äº†sequenceæ–‡ä»¶ï¼Œå°†sequenceä½œä¸ºå­˜å‚¨å°æ–‡ä»¶çš„å®¹å™¨ã€‚</p>
<p>Sequenceæ–‡ä»¶æ˜¯ç”±äºŒè¿›åˆ¶é”®å€¼å¯¹ç»„æˆçš„å¹³é¢æ–‡ä»¶ã€‚Hiveå°†æŸ¥è¯¢è½¬åŒ–æˆMapReduceä½œä¸šæ—¶ï¼Œå†³å®šä¸€ä¸ªç»™å®šè®°å½•çš„å“ªäº›é”®/å€¼å¯¹è¢«ä½¿ç”¨ã€‚Sequenceæ–‡ä»¶æ˜¯å¯åˆ†å‰²çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œä¸»è¦çš„ç”¨é€”æ˜¯è”åˆå¤šä¸ªå°æ–‡ä»¶ã€‚</p>
<p>SEQUENCEFILEæ ¼å¼çš„è¾“å…¥è¾“å‡ºåŒ…æ˜¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.apache.hadoop.mapred.SequenceFileInputFormat</span><br><span class="line">org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat</span><br></pre></td></tr></table></figure>
<h6 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a><span style="color:blue">ç¤ºä¾‹</span></h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å»ºç«‹SEQUENCEFILEæ ¼å¼çš„è¡¨</span></span><br><span class="line"><span class="keyword">use</span> <span class="keyword">test</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_sequencefile(</span><br><span class="line">    c1 <span class="keyword">string</span>, </span><br><span class="line">    c2 <span class="built_in">int</span>, </span><br><span class="line">    c3 <span class="keyword">string</span>, </span><br><span class="line">    c4 <span class="keyword">string</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> </span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span> </span><br><span class="line"><span class="keyword">stored</span> <span class="keyword">as</span> sequencefile;</span><br><span class="line"><span class="comment">-- å‘è¡¨ä¸­å¯¼å…¥æ•°æ®</span></span><br><span class="line"><span class="comment">-- ä¸TEXTFILEæœ‰äº›ä¸åŒï¼Œå› ä¸ºSEQUENCEFILEæ˜¯äºŒè¿›åˆ¶æ ¼å¼ï¼Œæ‰€ä»¥éœ€è¦ä»å…¶ä»–è¡¨å‘SEQUENCEFILEè¡¨æ’å…¥æ•°æ®</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> t_sequencefile <span class="keyword">select</span> * <span class="keyword">from</span> t_textfile;</span><br><span class="line"><span class="comment">-- æŸ¥è¯¢è¡¨</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t_sequencefile;</span><br></pre></td></tr></table></figure>
<h6 id="3-1-2-3-RCFILE"><a href="#3-1-2-3-RCFILE" class="headerlink" title="3.1.2.3 RCFILE"></a>3.1.2.3 RCFILE</h6><p>RCFILEæŒ‡çš„æ˜¯Record Columnar Fileï¼Œæ˜¯ä¸€ç§é«˜å‹ç¼©ç‡çš„äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼ï¼Œè¢«ç”¨äºåœ¨ä¸€ä¸ªæ—¶é—´ç‚¹æ“ä½œå¤šè¡Œçš„åœºæ™¯ã€‚RCFILEsæ˜¯ç”±äºŒè¿›åˆ¶é”®/å€¼å¯¹ç»„æˆçš„å¹³é¢æ–‡ä»¶ã€‚RCFILEä»¥è®°å½•çš„å½¢å¼å­˜å‚¨è¡¨ä¸­çš„åˆ—ï¼Œå³<strong>åˆ—å­˜å‚¨æ–¹å¼</strong>ã€‚å®ƒå…ˆåˆ†å‰²è¡Œåšæ°´å¹³åˆ†åŒºï¼Œç„¶ååˆ†å‰²åˆ—åšå‚ç›´åˆ†åŒºã€‚RCFILEæŠŠä¸€è¡Œçš„å…ƒæ•°æ®ä½œä¸ºé”®ï¼ŒæŠŠè¡Œæ•°æ®ä½œä¸ºå€¼ã€‚è¿™ç§é¢å‘åˆ—çš„å­˜å‚¨åœ¨æ‰§è¡Œæ•°æ®åˆ†ææ—¶æ›´é«˜æ•ˆã€‚</p>
<p>RCFILEæ ¼å¼çš„è¾“å…¥è¾“å‡ºåŒ…æ˜¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.apache.hadoop.hive.ql.io.RCFileInputFormat</span><br><span class="line">org.apache.hadoop.hive.ql.io.RCFileOutputFormat</span><br></pre></td></tr></table></figure>
<h6 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹"></a><span style="color:blue">ç¤ºä¾‹</span></h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å»ºç«‹RCFILEæ ¼å¼çš„è¡¨</span></span><br><span class="line"><span class="keyword">use</span> <span class="keyword">test</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_rcfile(</span><br><span class="line">    c1 <span class="keyword">string</span>, </span><br><span class="line">    c2 <span class="built_in">int</span>, </span><br><span class="line">    c3 <span class="keyword">string</span>, </span><br><span class="line">    c4 <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> </span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span> </span><br><span class="line"><span class="keyword">stored</span> <span class="keyword">as</span> rcfile;</span><br><span class="line"><span class="comment">-- å‘è¡¨ä¸­å¯¼å…¥æ•°æ®</span></span><br><span class="line"><span class="comment">-- ä¸èƒ½ç›´æ¥å‘RCFILEè¡¨ä¸­å¯¼å…¥æ•°æ®ï¼Œéœ€è¦ä»å…¶ä»–è¡¨å‘RCFILEè¡¨æ’å…¥æ•°æ®</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> t_rcfile <span class="keyword">select</span> * <span class="keyword">from</span> t_textfile;</span><br><span class="line"><span class="comment">-- æŸ¥è¯¢è¡¨</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t_rcfile;</span><br></pre></td></tr></table></figure>
<h6 id="3-1-2-4-ORCFILE"><a href="#3-1-2-4-ORCFILE" class="headerlink" title="3.1.2.4 ORCFILE"></a>3.1.2.4 ORCFILE</h6><p>ORCæŒ‡çš„æ˜¯Optimized Record Columnarï¼Œå³ç›¸å¯¹äºå…¶ä»–æ–‡ä»¶æ ¼å¼ï¼Œå®ƒä»¥æ›´ä¼˜åŒ–çš„æ–¹å¼å­˜å‚¨æ•°æ®ã€‚ORCèƒ½å°†åŸå§‹æ•°æ®çš„å¤§å°ç¼©å‡75%ï¼Œä»è€Œæå‡äº†æ•°æ®å¤„ç†çš„é€Ÿåº¦ã€‚ORCæ¯”Textã€Sequenceå’ŒRCæ–‡ä»¶æ ¼å¼æœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œè€Œä¸”ORCæ˜¯ç›®å‰Hiveä¸­å”¯ä¸€æ”¯æŒäº‹åŠ¡çš„æ–‡ä»¶æ ¼å¼ã€‚</p>
<p>ORCFILEæ ¼å¼çš„è¾“å…¥è¾“å‡ºåŒ…æ˜¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.hadoop.hive.ql.io.orc</span><br></pre></td></tr></table></figure>
<h6 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹"></a><span style="color:blue">ç¤ºä¾‹</span></h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å»ºç«‹ORCFILEæ ¼å¼çš„è¡¨</span></span><br><span class="line"><span class="keyword">use</span> <span class="keyword">test</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_orcfile(</span><br><span class="line">    c1 <span class="keyword">string</span>, </span><br><span class="line">    c2 <span class="built_in">int</span>, </span><br><span class="line">    c3 <span class="keyword">string</span>, </span><br><span class="line">    c4 <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> </span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span> </span><br><span class="line"><span class="keyword">stored</span> <span class="keyword">as</span> orcfile;</span><br><span class="line"><span class="comment">-- å‘è¡¨ä¸­å¯¼å…¥æ•°æ®</span></span><br><span class="line"><span class="comment">-- ä¸èƒ½ç›´æ¥å‘ORCFILEè¡¨ä¸­å¯¼å…¥æ•°æ®ï¼Œéœ€è¦ä»å…¶ä»–è¡¨å‘ORCFILEè¡¨æ’å…¥æ•°æ®</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> t_orcfile <span class="keyword">select</span> * <span class="keyword">from</span> t_textfile;</span><br><span class="line"><span class="comment">-- æŸ¥è¯¢è¡¨</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t_orcfile;</span><br></pre></td></tr></table></figure>
<h6 id="3-1-2-5-æ€»ç»“"><a href="#3-1-2-5-æ€»ç»“" class="headerlink" title="3.1.2.5 æ€»ç»“"></a>3.1.2.5 æ€»ç»“</h6><p>åº”è¯¥ä¾æ•°æ®éœ€æ±‚é€‰æ‹©é€‚å½“çš„æ–‡ä»¶æ ¼å¼ï¼Œå¦‚ï¼š</p>
<ul>
<li>å¦‚æœæ•°æ®æœ‰å‚æ•°åŒ–çš„åˆ†éš”ç¬¦ï¼Œé‚£ä¹ˆå¯ä»¥é€‰æ‹©TEXTFILEæ ¼å¼</li>
<li>å¦‚æœæ•°æ®æ‰€åœ¨æ–‡ä»¶æ¯”å—å°ºå¯¸å°ï¼Œå¯ä»¥é€‰æ‹©SEQUENCEFILEæ ¼å¼</li>
<li>å¦‚æœæƒ³æ‰§è¡Œæ•°æ®åˆ†æï¼Œå¹¶é«˜æ•ˆåœ°å­˜å‚¨æ•°æ®ï¼Œå¯ä»¥é€‰æ‹©RCFILEæ ¼å¼</li>
<li>å¦‚æœå¸Œæœ›å‡å°æ•°æ®æ‰€éœ€çš„å­˜å‚¨ç©ºé—´å¹¶æå‡æ€§èƒ½ï¼Œå¯ä»¥é€‰æ‹©ORCFILEæ ¼å¼</li>
</ul>
<h4 id="3-1-3-ä¾‹å­ï¼šåˆ›å»ºå†…éƒ¨è¡¨"><a href="#3-1-3-ä¾‹å­ï¼šåˆ›å»ºå†…éƒ¨è¡¨" class="headerlink" title="3.1.3 ä¾‹å­ï¼šåˆ›å»ºå†…éƒ¨è¡¨"></a>3.1.3 ä¾‹å­ï¼šåˆ›å»ºå†…éƒ¨è¡¨</h4><p>å¦‚ä¸‹ï¼šæ ¹æ®ä¸Šè¿°æ–‡ä»¶å†…å®¹(è§<a href="#jump3.1.1">3.1.1 row format</a>)ï¼Œåˆ›å»ºä¸€ä¸ªè¡¨t1</p>
<h5 id="1-åˆ›å»ºè¡¨"><a href="#1-åˆ›å»ºè¡¨" class="headerlink" title="1. åˆ›å»ºè¡¨"></a>1. åˆ›å»ºè¡¨</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1(</span><br><span class="line">    <span class="keyword">id</span>      <span class="built_in">int</span>,</span><br><span class="line">    <span class="keyword">name</span>    <span class="keyword">string</span>,</span><br><span class="line">    hobby   <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;,</span><br><span class="line">    <span class="keyword">add</span>     <span class="keyword">map</span>&lt;<span class="keyword">String</span>,<span class="keyword">string</span>&gt;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span></span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">','</span></span><br><span class="line">collection items <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'-'</span></span><br><span class="line"><span class="keyword">map</span> <span class="keyword">keys</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">':'</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>
<p> <img src="/2020/01/12/Hiveä»‹ç»/1603599880662.png" alt="1603599880662"></p>
<h5 id="2-æŸ¥çœ‹è¡¨çš„æè¿°"><a href="#2-æŸ¥çœ‹è¡¨çš„æè¿°" class="headerlink" title="2.æŸ¥çœ‹è¡¨çš„æè¿°"></a>2.æŸ¥çœ‹è¡¨çš„æè¿°</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">desc t1;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/01/12/Hiveä»‹ç»/1603599824805.png" alt="1603599824805"></p>
<h5 id="3-è£…è½½æ•°æ®"><a href="#3-è£…è½½æ•°æ®" class="headerlink" title="3. è£…è½½æ•°æ®"></a><span id="jump3.1.3.3">3. è£…è½½æ•°æ®</span></h5><blockquote>
<p>å‚è€ƒã€ŠHadoopæ„å»ºæ•°æ®ä»“åº“å®è·µã€‹</p>
</blockquote>
<h6 id="a-å‘éåˆ†åŒºè¡¨ä¸­è£…è½½æ•°æ®"><a href="#a-å‘éåˆ†åŒºè¡¨ä¸­è£…è½½æ•°æ®" class="headerlink" title="a. å‘éåˆ†åŒºè¡¨ä¸­è£…è½½æ•°æ®"></a>a. å‘éåˆ†åŒºè¡¨ä¸­è£…è½½æ•°æ®</h6><p><strong>ï¼ˆ1ï¼‰ä½¿ç”¨ LOAD</strong></p>
<p>å…ˆå‡†å¤‡ä¸€ä¸ªæœ¬åœ°æ–‡æœ¬æ–‡ä»¶ a.txtï¼Œå…¶ä¸­åªæœ‰ä¸€è¡Œè®°å½• â€˜aaaâ€™.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;mkdir test</span><br><span class="line">&gt;cd test</span><br><span class="line">&gt;echo &apos;aaa&apos; &gt; a.txt</span><br></pre></td></tr></table></figure>
<p>å°†è¿™è¡Œè®°å½•è£…è½½åˆ°ä¸€ä¸ªè¡¨ä¸­ï¼Œå¹¶æŸ¥çœ‹HDFSä¸Šç”Ÿæˆçš„æ•°æ®æ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; use test;</span><br><span class="line">hive&gt; drop table if exists t1;</span><br><span class="line">hive&gt; create table t1(name string);</span><br><span class="line">hive&gt; load data local inpath &apos;/root/test&apos; into table t1;</span><br><span class="line">hive&gt; select * from t1;</span><br><span class="line">aaa</span><br><span class="line">hive&gt; dfs -ls /user/hive/warehouse/test.db/t1;</span><br><span class="line">Found 1 items</span><br><span class="line">-rwxrwxrwt	3	root	hive	4	2016-10-20	13:52	/user/hive/warehouse/test.db/t1/a.txt</span><br><span class="line">hive&gt; dfs -cat /user/hive/warehouse/test.db/t1/a.txt;</span><br><span class="line">aaa</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œhiveå‘½ä»¤è¡Œä¸­é™¤äº†å¯ä»¥æ‰§è¡ŒHiveQLè¯­å¥ï¼Œè¿˜å¯ä»¥æ‰§è¡ŒHadoopçš„dfså‘½ä»¤ã€‚<strong>Loadè¯­å¥å®é™…æ‰§è¡Œäº†ä¸€ä¸ªå¤åˆ¶æ–‡ä»¶çš„æ“ä½œ</strong>ã€‚é€šå¸¸æˆ‘ä»¬åœ¨loadè¯­å¥ä¸­æŒ‡å®šçš„è·¯å¾„æ˜¯ä¸€ä¸ªç›®å½•ï¼Œè€Œä¸æ˜¯å•ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ã€‚Hiveä¼šå°†è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶éƒ½å¤åˆ¶åˆ°ç›®æ ‡ä½ç½®ã€‚è¿™ä½¿å¾—ç”¨æˆ·å°†æ›´æ–¹ä¾¿åœ°ç»„ç»‡æ•°æ®åˆ°å¤šä¸ªæ–‡ä»¶ä¸­ï¼ŒåŒæ—¶å¯ä»¥åœ¨ä¸ä¿®æ”¹Hiveè„šæœ¬çš„å‰æä¸‹ä¿®æ”¹æ–‡ä»¶å‘½åè§„åˆ™ã€‚æ–‡ä»¶ä¼šè¢«å¤åˆ¶åˆ°ç›®æ ‡è·¯å¾„ä¸‹è€Œä¸”æ–‡ä»¶åä¿æŒä¸å˜ã€‚</p>
<p>ä¸Šé¢çš„HiveQLè¯­å¥å‘t1è¡¨ä¸­è£…è½½äº†æ•°æ®â€™aaaâ€™ï¼Œå¹¶åœ¨é»˜è®¤çš„æ•°æ®ä»“åº“ç›®å½•ä¸‹ç”Ÿæˆäº†æ•°æ®æ–‡ä»¶ /user/hive/warehouse/test.db/t1/a.txtï¼Œå®é™…ä¸Šæ•°æ®æ–‡ä»¶æ˜¯çº¯æ–‡æœ¬æ ¼å¼ï¼Œå†…å®¹å°±æ˜¯ â€˜aaaâ€™ã€‚</p>
<p>åœ¨æœ¬åœ°æ–‡ä»¶a.txtä¸­æ·»åŠ ä¸€è¡Œâ€™bbbâ€™ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;bbb&apos; &gt;&gt; a.txt</span><br></pre></td></tr></table></figure>
<p>ç„¶åå†æ‰§è¡Œä¸‹é¢çš„HiveQLè¯­å¥å¹¶æŸ¥çœ‹ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; load data local inpath &apos;/root/test&apos; into table t1;</span><br><span class="line">hive&gt; select * from t1;</span><br><span class="line">aaa</span><br><span class="line">aaa</span><br><span class="line">bbb</span><br><span class="line">hive&gt; dfs -ls /user/hive/warehouse/test.db/t1;</span><br><span class="line">Found 2 items</span><br><span class="line">-rwxrwxrwt	3	root	hive	4	2016-10-20	13:52	/user/hive/warehouse/test.db/t1/a.txt</span><br><span class="line">-rwxrwxrwt	3	root	hive	8	2016-10-20	14:18	/user/hive/warehouse/test.db/t1/a_copy_1.txt</span><br><span class="line">hive&gt; dfs -cat /user/hive/warehouse/test.db/t1/a.txt;</span><br><span class="line">aaa</span><br><span class="line">hive&gt; dfs -cat /user/hive/warehouse/test.db/t1/a_copy_1.txt;</span><br><span class="line">aaa</span><br><span class="line">bbb</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç°åœ¨è¡¨ä¸­æœ‰3æ¡æ•°æ®ï¼Œå¹¶ä¸”æ–°ç”Ÿæˆäº†æ•°æ®æ–‡ä»¶a_copy_1.txtã€‚åŸæ¥çš„a.txtæ–‡ä»¶ä¸­çš„å†…å®¹è¿˜æ˜¯â€™aaaâ€™ï¼Œæ–°ç”Ÿæˆçš„a_copy_1.txtæ–‡ä»¶ä¸­çš„å†…å®¹æ˜¯ç¬¬äºŒæ¬¡è£…è½½çš„ä¸¤è¡Œæ•°æ®ã€‚å³ï¼Œæ¯æ¬¡è£…è½½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œå¦‚æœç›®å½•ä¸­è£…è½½çš„æ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆå†æ¬¡è£…è½½ä¼šç”Ÿæˆä¸€ä¸ªåŸæ–‡ä»¶çš„å¤åˆ¶ï¼Œè¡¨ä¸­æ•°æ®å¯¹åº”çš„æ˜¯è¡¨ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶çš„å†…å®¹ã€‚</p>
<p><strong>ï¼ˆ2ï¼‰ä½¿ç”¨ LOAD OVERWRITE</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; drop table if exists t2;</span><br><span class="line">hive&gt; create table t2(name string);</span><br><span class="line">hive&gt; load data local inpath &apos;/root/test&apos; overwrite into table t2;</span><br><span class="line">hive&gt; select * from t2;</span><br><span class="line">aaa</span><br><span class="line">bbb</span><br><span class="line">hive&gt; dfs -ls /user/hive/warehouse/test.db/t2;</span><br><span class="line">Found 1 items</span><br><span class="line">-rwxrwxrwt	3	root	hive	8	2016-10-20	14:43	/user/hive/warehouse/test.db/t2/a.txt</span><br><span class="line">hive&gt; dfs -cat /user/hive/warehouse/test.db/t2/a.txt;</span><br><span class="line">aaa</span><br><span class="line">bbb</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç°åœ¨t2è¡¨ä¸­åªæœ‰ä¸¤æ¡æ•°æ®ï¼Œåœ¨è¡¨ç›®å½•ä¸‹ç”Ÿæˆäº†æ•°æ®æ–‡ä»¶a.txtã€‚ç°åœ¨ç¼–è¾‘æœ¬åœ°æ–‡ä»¶a.txtï¼Œä½¿å…¶åªæœ‰ä¸€è¡Œâ€™cccâ€™ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;ccc&apos; &gt; a.txt</span><br></pre></td></tr></table></figure>
<p>å†æ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; load data local inpath &apos;/root/test&apos; overwrite into table t2;</span><br><span class="line">hive&gt; select * from t2;</span><br><span class="line">ccc</span><br><span class="line">hive&gt; dfs -ls /user/hive/warehouse/test.db/t2;</span><br><span class="line">Found 1 items</span><br><span class="line">-rwxrwxrwt	3	root	hive	4	2016-10-20	14:50	/user/hive/warehouse/test.db/t2/a.txt</span><br><span class="line">hive&gt; dfs -cat /user/hive/warehouse/test.db/t2/a.txt;</span><br><span class="line">ccc</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç°åœ¨è¡¨ä¸­åªæœ‰ä¸€æ¡æ•°æ®â€™cccâ€™ï¼Œæ•°æ®æ–‡ä»¶åæ²¡å˜ï¼Œä½†å…¶å†…å®¹é‡æ–°ç”Ÿæˆã€‚</p>
<h6 id="b-å‘åˆ†åŒºè¡¨ä¸­è£…è½½æ•°æ®"><a href="#b-å‘åˆ†åŒºè¡¨ä¸­è£…è½½æ•°æ®" class="headerlink" title="b. å‘åˆ†åŒºè¡¨ä¸­è£…è½½æ•°æ®"></a>b. å‘åˆ†åŒºè¡¨ä¸­è£…è½½æ•°æ®</h6><p><strong>ï¼ˆ1ï¼‰load</strong></p>
<p>å‡†å¤‡æœ¬åœ°æ–‡æœ¬æ–‡ä»¶a.txtï¼Œå…¶ä¸­åªæœ‰ä¸€è¡Œâ€™aaaâ€™ï¼Œç„¶åæ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; create table  t1(name string) partitioned by (country string, state string);</span><br><span class="line">hive&gt; dfs -ls /user/hive/warehouse/test.db/t1;</span><br><span class="line">hive&gt; load data local inpath &apos;/root/test&apos; into table t1 partition (country=&apos;us&apos;, state=&apos;ca&apos;);</span><br><span class="line">hive&gt; select * from t1;</span><br><span class="line">aaa	us	ca</span><br><span class="line">hive&gt; dfs -ls /user/hive/warehouse/test.db/t1/country=us/state=ca;</span><br><span class="line">Found 1 items</span><br><span class="line">-rwxrwxrwt	3	root	hive	4	2016-10-20	15:10	/user/hive/warehouse/test.db/t1/country=us/state=ca/a.txt</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå»ºç«‹t1è¡¨åï¼Œè£…è½½æ•°æ®å‰ï¼Œè¡¨ç›®å½•ä¸‹æ²¡æœ‰ä»»ä½•æ–‡ä»¶ã€‚<strong>loadè¯­å¥åˆ›å»ºäº†åˆ†åŒºç›®å½•country=us/state=caï¼Œå¹¶å°†æœ¬åœ°æ–‡ä»¶å¤åˆ¶åˆ°åˆ†åŒºç›®å½•ä¸‹</strong>ã€‚ä»æŸ¥è¯¢çš„è§’åº¦çœ‹ï¼Œ<strong>å‘t1è¡¨ä¸­è£…è½½äº†æ•°æ®â€™aaaâ€™</strong>ã€‚<strong>æŸ¥è¯¢ç»“æœæ˜¾ç¤ºäº†ä¸‰åˆ—ï¼Œé™¤äº†åŸå§‹çš„æ–‡æœ¬æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œè¿˜åŒ…æ‹¬äº†ä¸¤ä¸ªåˆ†åŒºåˆ—çš„å€¼ã€‚åˆ†åŒºåˆ—æ€»æ˜¯åœ¨è¡¨çš„æœ€åæ˜¾ç¤º</strong>ã€‚</p>
<p>load overwriteè£…è½½æ•°æ®ä¸éåˆ†åŒºè¡¨ç±»ä¼¼ï¼Œä¸å†èµ˜è¿°ã€‚</p>
<p><strong>ï¼ˆ2ï¼‰alter table tablename add partition</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">hive&gt; alter table t1 add partition(country=&apos;us&apos;, state=&apos;cb&apos;) location &apos;/a&apos;;</span><br><span class="line">hive&gt; dfs -ls /user/hive/warehouse/test.db/t1/country=us;</span><br><span class="line">Found 1 items</span><br><span class="line">drwxrwxrwt	-	root	hive	0	2016-10-20	15:40	/user/hive/warehouse/test.db/t1/country=us/state=ca</span><br><span class="line">hive&gt; select * from t1;</span><br><span class="line">aaa	us	ca</span><br><span class="line">hive&gt; dfs -cp /user/hive/warehouse/test.db/t1/country=us/state=ca/a.txt /a;</span><br><span class="line">hive&gt; select * from t1;</span><br><span class="line">aaa	us	ca</span><br><span class="line">aaa	us	cb</span><br><span class="line">hive&gt; dfs -ls /user/hive/warehouse/test.db/t1/country=us;</span><br><span class="line">Found 1 items</span><br><span class="line">drwxrwxrwt	-	root	hive	0	2016-10-20	15:40	/user/hive/warehouse/test.db/t1/country=us/state=ca</span><br><span class="line">hive&gt; dfs -ls /a;</span><br><span class="line">Found 1 items</span><br><span class="line">-rw-r--r--	3	root	supergroup	4	2016-10-20	15:41	/a/a.txt</span><br><span class="line">hive&gt; dfs -rm /user/hive/warehouse/test.db/t1/country=us/state=ca/a.txt;</span><br><span class="line">hive&gt; select * from t1;</span><br><span class="line">aaa	us	cb</span><br></pre></td></tr></table></figure>
<p>è¯´æ˜ï¼šè¡¨ä¸­åŸæœ‰ä¸€æ¡æ•°æ®â€™aaaâ€™ã€‚æ·»åŠ ä¸€ä¸ªæ–°åˆ†åŒºï¼Œå¹¶æŒ‡å®šä½ç½®ä¸ºâ€™/aâ€™ã€‚æŠŠå·²ç»å­˜åœ¨çš„æ•°æ®æ–‡ä»¶a.txtå¤åˆ¶åˆ°ç›®å½•â€™/aâ€™é‡Œã€‚æ­¤æ—¶æŸ¥è¯¢å·²ç»æœ‰å±äºä¸åŒåˆ†åŒºçš„ä¸¤æ¡æ•°æ®ã€‚åˆ é™¤country=â€™usâ€™ä¸”state=â€™caâ€™åˆ†åŒºçš„æ•°æ®æ–‡ä»¶ã€‚æ­¤æ—¶æŸ¥è¯¢è¡¨åªæœ‰å±äºcountry=â€™usâ€™ä¸”state=â€™cbâ€™åˆ†åŒºçš„ä¸€æ¡æ•°æ®ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­HDFSä¸­éƒ½æ²¡æœ‰å­˜åœ¨è¿‡coutry=us/state=cbçš„ç›®å½•ã€‚</p>
<p><strong>å¯¹Hiveè¡¨çš„æ•°æ®è£…è½½ç‰¹æ€§æ€»ç»“å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li>loadä¸load overwriteçš„åŒºåˆ«æ˜¯ï¼š<ul>
<li>loadï¼šæ¯æ¬¡æ‰§è¡Œä¼šç”Ÿæˆæ–°çš„æ•°æ®æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­æ˜¯æœ¬æ¬¡è£…è½½çš„æ•°æ®ï¼Œè¡¨ä¸­æ•°æ®å¯¹åº”çš„æ˜¯è¡¨ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶çš„å†…å®¹ã€‚</li>
<li>load overwriteï¼šè‹¥è¡¨ï¼ˆæˆ–åˆ†åŒºï¼‰çš„æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨åˆ™ç”Ÿæˆï¼Œå­˜åœ¨åˆ™é‡æ–°ç”Ÿæˆæ•°æ®æ–‡ä»¶å†…å®¹ï¼ˆè¦†ç›–æ‰ä»¥å‰çš„ï¼‰ã€‚</li>
</ul>
</li>
<li>åˆ†åŒºè¡¨æ¯”éåˆ†åŒºè¡¨å¤šäº†ä¸€ç§alter table â€¦ add partitionçš„æ•°æ®è£…è½½æ–¹å¼</li>
<li>å¯¹äºåˆ†åŒºè¡¨ï¼ˆæ— è®ºå†…éƒ¨è¿˜æ˜¯å¤–éƒ¨ï¼‰ï¼Œloadä¸load overwriteä¼šè‡ªåŠ¨å»ºç«‹åä¸ºåˆ†åŒºé”®å€¼çš„ç›®å½•ï¼Œè€Œalter table â€¦ add partitionï¼Œåªè¦ç”¨locationæŒ‡å®šæ•°æ®æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•å³å¯ã€‚</li>
<li>å¯¹äºå¤–éƒ¨è¡¨ï¼Œé™¤äº†åœ¨åˆ é™¤è¡¨æ—¶åªåˆ é™¤å…ƒæ•°æ®è€Œä¿ç•™è¡¨æ•°æ®ç›®å½•å¤–ï¼Œå…¶æ•°æ®è£…è½½è¡Œä¸ºä¸å†…éƒ¨è¡¨ç›¸åŒã€‚</li>
</ul>
<hr>
<p>åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç²˜è´´ä¸Šè¿°è®°å½•ï¼Œå¹¶ä¸Šè½½å³å¯ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="/2020/01/12/Hiveä»‹ç»/1603600131112.png" alt="1603600131112"></p>
<p>ç„¶åä¸Šè½½</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load data local inpath &apos;/home/hadoop/Desktop/data&apos; overwrite into table t1;</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹è¡¨å†…å®¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t1;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/01/12/Hiveä»‹ç»/1603600188322.png" alt="1603600188322"></p>
<h5 id="4-æŸ¥çœ‹æ–‡ä»¶ä½ç½®"><a href="#4-æŸ¥çœ‹æ–‡ä»¶ä½ç½®" class="headerlink" title="4. æŸ¥çœ‹æ–‡ä»¶ä½ç½®"></a>4. æŸ¥çœ‹æ–‡ä»¶ä½ç½®</h5><p>t1è¡¨åœ¨å“ªå„¿å‘¢ï¼Ÿåœ¨æˆ‘ä»¬ä¹‹å‰é…ç½®çš„é»˜è®¤è·¯å¾„é‡Œï¼ˆ/user/hive/warehouseï¼‰</p>
<p><img src="/2020/01/12/Hiveä»‹ç»/1603609902727.png" alt="1603609902727"></p>
<p>é€šè¿‡å‘½ä»¤è¡Œè·å–ä½ç½®ä¿¡æ¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">desc formatted table_name;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/01/12/Hiveä»‹ç»/1603610044780.png" alt="1603610044780"></p>
<h5 id="5-åˆ é™¤å†…éƒ¨è¡¨"><a href="#5-åˆ é™¤å†…éƒ¨è¡¨" class="headerlink" title="5. åˆ é™¤å†…éƒ¨è¡¨"></a>5. åˆ é™¤å†…éƒ¨è¡¨</h5><p><img src="/2020/01/12/Hiveä»‹ç»/1603610161316.png" alt="1603610161316"></p>
<p><img src="/2020/01/12/Hiveä»‹ç»/1603610193337.png" alt="1603610193337"></p>
<p>è§‚å¯ŸHDFSä¸Šçš„æ–‡ä»¶ï¼Œå‘ç°t1å·²ç»ä¸åœ¨äº†</p>
<p><img src="/2020/01/12/Hiveä»‹ç»/1603610402205.png" alt="1603610402205"></p>
<h4 id="3-1-4-ä¾‹å­ï¼šåˆ›å»ºå¤–éƒ¨è¡¨"><a href="#3-1-4-ä¾‹å­ï¼šåˆ›å»ºå¤–éƒ¨è¡¨" class="headerlink" title="3.1.4 ä¾‹å­ï¼šåˆ›å»ºå¤–éƒ¨è¡¨"></a>3.1.4 ä¾‹å­ï¼šåˆ›å»ºå¤–éƒ¨è¡¨</h4><h5 id="1-åˆ›å»ºè¡¨-1"><a href="#1-åˆ›å»ºè¡¨-1" class="headerlink" title="1. åˆ›å»ºè¡¨"></a>1. åˆ›å»ºè¡¨</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> t2(</span><br><span class="line">    <span class="keyword">id</span>      <span class="built_in">int</span></span><br><span class="line">   ,<span class="keyword">name</span>    <span class="keyword">string</span></span><br><span class="line">   ,hobby   <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;</span><br><span class="line">   ,<span class="keyword">add</span>     <span class="keyword">map</span>&lt;<span class="keyword">String</span>,<span class="keyword">string</span>&gt;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span></span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">','</span></span><br><span class="line">collection items <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'-'</span></span><br><span class="line"><span class="keyword">map</span> <span class="keyword">keys</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">':'</span></span><br><span class="line">location <span class="string">'/user/t2'</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/01/12/Hiveä»‹ç»/1603600496450.png" alt="1603600496450"></p>
<h5 id="2-è£…è½½æ•°æ®"><a href="#2-è£…è½½æ•°æ®" class="headerlink" title="2. è£…è½½æ•°æ®"></a>2. è£…è½½æ•°æ®</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">load data local inpath &apos;/home/hadoop/Desktop/data&apos; overwrite into table t2;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/01/12/Hiveä»‹ç»/1603600549196.png" alt="1603600549196"></p>
<h5 id="3-æŸ¥çœ‹æ–‡ä»¶ä½ç½®"><a href="#3-æŸ¥çœ‹æ–‡ä»¶ä½ç½®" class="headerlink" title="3. æŸ¥çœ‹æ–‡ä»¶ä½ç½®"></a>3. æŸ¥çœ‹æ–‡ä»¶ä½ç½®</h5><p>åœ¨/user/ç›®å½•ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°t2æ–‡ä»¶</p>
<p><img src="/2020/01/12/Hiveä»‹ç»/1603609992170.png" alt="1603609992170"></p>
<p>é€šè¿‡å‘½ä»¤è¡Œè·å¾—ä½ç½®ä¿¡æ¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">desc formatted table_name;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/01/12/Hiveä»‹ç»/1603610068333.png" alt="1603610068333"></p>
<h5 id="4-åˆ é™¤å¤–éƒ¨è¡¨"><a href="#4-åˆ é™¤å¤–éƒ¨è¡¨" class="headerlink" title="4. åˆ é™¤å¤–éƒ¨è¡¨"></a>4. åˆ é™¤å¤–éƒ¨è¡¨</h5><p><img src="/2020/01/12/Hiveä»‹ç»/1603610449476.png" alt="1603610449476"></p>
<p><img src="/2020/01/12/Hiveä»‹ç»/1603610471246.png" alt="1603610471246"></p>
<p>è§‚å¯ŸHDFSä¸Šçš„æ–‡ä»¶ï¼Œt2ä»ç„¶å­˜åœ¨</p>
<p><img src="/2020/01/12/Hiveä»‹ç»/1603610518016.png" alt="1603610518016"></p>
<p>å› è€Œåˆ é™¤å¤–éƒ¨è¡¨ä»…ä»…ä¼šåˆ é™¤å…ƒæ•°æ®ã€‚</p>
<p>é‡æ–°åˆ›å»ºå¤–éƒ¨è¡¨t2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">create external table t2(</span><br><span class="line">    id      int</span><br><span class="line">   ,name    string</span><br><span class="line">   ,hobby   array&lt;string&gt;</span><br><span class="line">   ,add     map&lt;String,string&gt;</span><br><span class="line">)</span><br><span class="line">row format delimited</span><br><span class="line">fields terminated by &apos;,&apos;</span><br><span class="line">collection items terminated by &apos;-&apos;</span><br><span class="line">map keys terminated by &apos;:&apos;</span><br><span class="line">location &apos;/user/t2&apos;</span><br><span class="line">;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/01/12/Hiveä»‹ç»/1603610616445.png" alt="1603610616445"></p>
<p>ä¸å¾€é‡Œé¢æ’å…¥æ•°æ®ï¼Œæˆ‘ä»¬select * çœ‹çœ‹ç»“æœ</p>
<p><img src="/2020/01/12/Hiveä»‹ç»/1603610644871.png" alt="1603610644871"></p>
<p>å¯è§æ•°æ®ä»ç„¶åœ¨ï¼</p>
<h3 id="3-2-æ³•äºŒï¼šæŸ¥è¯¢å»ºè¡¨æ³•ï¼ˆCreate-Table-As-Select-CTAS-ï¼‰"><a href="#3-2-æ³•äºŒï¼šæŸ¥è¯¢å»ºè¡¨æ³•ï¼ˆCreate-Table-As-Select-CTAS-ï¼‰" class="headerlink" title="3.2 æ³•äºŒï¼šæŸ¥è¯¢å»ºè¡¨æ³•ï¼ˆCreate Table As Select (CTAS)ï¼‰"></a>3.2 æ³•äºŒï¼šæŸ¥è¯¢å»ºè¡¨æ³•ï¼ˆCreate Table As Select (CTAS)ï¼‰</h3><p>é€šè¿‡AS æŸ¥è¯¢è¯­å¥å®Œæˆå»ºè¡¨ï¼š<strong>å°†å­æŸ¥è¯¢çš„ç»“æœå­˜åœ¨æ–°è¡¨é‡Œï¼Œæœ‰æ•°æ®</strong><br>ä¸€èˆ¬ç”¨äºä¸­é—´è¡¨ã€‚</p>
<p>å¯ä»¥é€šè¿‡ä¸€ä¸ªcreate-table-as-selectï¼ˆCTASï¼‰è¯­å¥ä¸­çš„æŸ¥è¯¢ç»“æœæ¥åˆ›å»ºå’Œå¡«å……è¡¨ã€‚ CTASåˆ›å»ºçš„è¡¨æ˜¯åŸå­è¡¨ï¼Œè¿™æ„å‘³ç€åœ¨å¡«å……æ‰€æœ‰æŸ¥è¯¢ç»“æœä¹‹å‰ï¼Œå…¶ä»–ç”¨æˆ·ä¸ä¼šçœ‹åˆ°è¯¥è¡¨ã€‚å› æ­¤ï¼Œå…¶ä»–ç”¨æˆ·è¦ä¹ˆçœ‹åˆ°åŒ…å«å®Œæ•´æŸ¥è¯¢ç»“æœçš„è¡¨ï¼Œè¦ä¹ˆæ ¹æœ¬çœ‹ä¸åˆ°è¡¨ã€‚</p>
<p>CTASæœ‰ä¸¤éƒ¨åˆ†ï¼ŒSELECTéƒ¨åˆ†å¯ä»¥æ˜¯HiveQLæ”¯æŒçš„ä»»ä½•SELECTè¯­å¥ (<a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Select" target="_blank" rel="noopener">SELECT statement</a>)ï¼› CREATEéƒ¨åˆ†ä»SELECTéƒ¨åˆ†è·å–schemaï¼Œå¹¶ä½¿ç”¨å…¶ä»–è¡¨å±æ€§ï¼ˆä¾‹å¦‚SerDeå’Œå­˜å‚¨æ ¼å¼ï¼‰åˆ›å»ºç›®æ ‡è¡¨ã€‚( The CREATE part of the CTAS takes the resulting schema from the SELECT part and creates the target table with other table properties such as the SerDe and storage format.)</p>
<p>CTASå…·æœ‰ä»¥ä¸‹é™åˆ¶ï¼š</p>
<blockquote>
<p>å‚è€ƒ <a href="https://blog.csdn.net/qq_26442553/article/details/79593504" target="_blank" rel="noopener">ä½¿ç”¨create table â€¦asåˆ›å»ºè¡¨æ—¶è¦æ³¨æ„çš„é—®é¢˜_æ¶¤ç”Ÿæ‰‹è®°-CSDNåšå®¢</a></p>
</blockquote>
<ul>
<li><p>ç›®æ ‡è¡¨ä¸èƒ½æ˜¯å¤–éƒ¨è¡¨ã€‚</p>
</li>
<li><p>ç›®æ ‡è¡¨ä¸èƒ½æ˜¯åˆ—è¡¨å­˜å‚¨è¡¨ (list bucketing table)ã€‚</p>
</li>
<li><p>hiveä¸­ç”¨CTASåˆ›å»ºè¡¨ï¼Œæ‰€åˆ›å»ºçš„è¡¨ç»Ÿä¸€éƒ½æ˜¯éåˆ†åŒºè¡¨ï¼Œä¸ç®¡æºè¡¨æ˜¯å¦æ˜¯åˆ†åŒºè¡¨ã€‚æ‰€ä»¥å¯¹äºåˆ†åŒºè¡¨çš„åˆ›å»ºä½¿ç”¨CTASä¸€å®šè¦æ³¨æ„åˆ†åŒºåŠŸèƒ½çš„ä¸¢å¤±ã€‚å½“ç„¶åˆ›å»ºè¡¨ä»¥åå¯ä»¥æ·»åŠ åˆ†åŒºï¼Œæˆä¸ºåˆ†åŒºè¡¨ï¼ˆä»Hive 3.2.0å¼€å§‹ï¼ŒCTASè¯­å¥å¯ä»¥ä¸ºç›®æ ‡è¡¨å®šä¹‰åˆ†åŒºè§„èŒƒã€‚(can define a partitioning specification for the target table (<a href="https://issues.apache.org/jira/browse/HIVE-20241" target="_blank" rel="noopener">HIVE-20241</a>) ç¤ºä¾‹å¦‚ä¸‹ï¼šï¼ˆå…³äºå¦‚ä½•æŸ¥è¯¢hiveç‰ˆæœ¬ï¼Œè§ <a href="#jump6">6.å‘½ä»¤</a>ï¼‰ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE partition_ctas_1 PARTITIONED BY (key) AS</span><br><span class="line">SELECT value, key FROM src where key &gt; 200 and key &lt; 300;</span><br></pre></td></tr></table></figure>
</li>
<li><p>CTASåˆ›å»ºè¡¨æ—¶ä¸èƒ½æ·»åŠ æ³¨é‡Šï¼Œè¿™ç§æ–¹å¼å¤šç”¨äºä¸´æ—¶è¡¨ã€ä¸­é—´è¡¨çš„åˆ›å»ºï¼Œä¸æ˜¯ç»“æœè¡¨ï¼Œä¸”å³ä½¿æºè¡¨æœ‰æ³¨é‡Šï¼Œä½¿ç”¨CTASåˆ›å»ºçš„è¡¨ä¹Ÿä¼šä¸¢å¤±æºè¡¨çš„å­—æ®µæ³¨é‡Šã€‚</p>
</li>
</ul>
<p>ä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE new_key_value_store</span><br><span class="line">   ROW FORMAT SERDE &quot;org.apache.hadoop.hive.serde2.columnar.ColumnarSerDe&quot;</span><br><span class="line">   STORED AS RCFile</span><br><span class="line">   AS</span><br><span class="line">SELECT (key % 1024) new_key, concat(key, value) key_value_pair</span><br><span class="line">FROM key_value_store</span><br><span class="line">SORT BY new_key, key_value_pair;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„CTASè¯­å¥ä½¿ç”¨ä»SELECTè¯­å¥ç»“æœå¾—åˆ°çš„schemaï¼ˆnew_key DOUBLEï¼Œkey_value_pair STRINGï¼‰åˆ›å»ºç›®æ ‡è¡¨new_key_value_storeã€‚å¦‚æœSELECTè¯­å¥æœªæŒ‡å®šåˆ—åˆ«åï¼Œåˆ™åˆ—åå°†è‡ªåŠ¨åˆ†é…ç»™_col0ï¼Œ_col1å’Œ_col2ç­‰ã€‚æ­¤å¤–ï¼Œæ–°ç›®æ ‡è¡¨æ˜¯ä½¿ç”¨ç‰¹å®šçš„SerDeå’Œå­˜å‚¨æ ¼å¼åˆ›å»ºçš„ï¼Œç‹¬ç«‹äºSELECTè¯­å¥é‡Œçš„æºè¡¨ã€‚</p>
<p>Starting with <a href="https://issues.apache.org/jira/browse/HIVE-1180" target="_blank" rel="noopener">Hive 0.13.0</a>, the SELECT statement can include one or more common table expressions (CTEs), as shown in the <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Select#LanguageManualSelect-SelectSyntax" target="_blank" rel="noopener">SELECT syntax</a>. For an example, see <a href="https://cwiki.apache.org/confluence/display/Hive/Common+Table+Expression#CommonTableExpression-CTEinViews,CTAS,andInsertStatements" target="_blank" rel="noopener">Common Table Expression</a>.<br>ï¼ˆå…³äºCTEsçš„ä»‹ç»è§ <a href="https://www.cnblogs.com/Neo-ds/p/4804900.html" target="_blank" rel="noopener">Common Table Expressions (CTE) - ndong - åšå®¢å›­ (cnblogs.com)</a>ï¼‰</p>
<p>èƒ½å¤Ÿ<strong>ä»ä¸€ä¸ªè¡¨é€‰æ‹©æ•°æ®åˆ°å¦ä¸€ä¸ªè¡¨</strong>æ˜¯Hiveæœ€å¼ºå¤§çš„ç‰¹æ€§ä¹‹ä¸€ã€‚Hiveåœ¨æ‰§è¡ŒæŸ¥è¯¢æ—¶å¤„ç†æ•°æ®ä»æºæ ¼å¼åˆ°ç›®æ ‡æ ¼å¼çš„è½¬æ¢ã€‚</p>
<p>æ ¹æ®ä¾‹å­æˆ‘ä»¬å»ºä¸€å¼ è¡¨ï¼št3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create table t3 as</span><br><span class="line">select</span><br><span class="line">    id,</span><br><span class="line">    name</span><br><span class="line">from t2</span><br><span class="line">;</span><br></pre></td></tr></table></figure>
<p>ä¼šæ‰§è¡ŒMapReduceè¿‡ç¨‹ã€‚<br>æŸ¥çœ‹è¡¨ç»“æ„åŠå†…å®¹ï¼Œå‘ç°æ˜¯æœ‰æ•°æ®çš„ï¼Œå¹¶ä¸”ç”±äºæ²¡æœ‰æŒ‡å®šå¤–éƒ¨è¡¨å’Œlocationï¼Œè¯¥è¡¨åœ¨é»˜è®¤ä½ç½®ï¼Œå³æ˜¯å†…éƒ¨è¡¨ã€‚</p>
<p><img src="/2020/01/12/Hiveä»‹ç»/1603613699566.png" alt="1603613699566"></p>
<h3 id="3-3-æ³•ä¸‰ï¼šlikeå»ºè¡¨æ³•"><a href="#3-3-æ³•ä¸‰ï¼šlikeå»ºè¡¨æ³•" class="headerlink" title="3.3 æ³•ä¸‰ï¼šlikeå»ºè¡¨æ³•"></a>3.3 æ³•ä¸‰ï¼šlikeå»ºè¡¨æ³•</h3><p><strong>ä¼šåˆ›å»ºç»“æ„å®Œå…¨ç›¸åŒçš„è¡¨ï¼Œä½†æ˜¯æ²¡æœ‰æ•°æ®ã€‚</strong><br>å¸¸ç”¨äºä¸­é—´è¡¨.</p>
<p><strong>(å°è¯•è¿‡likeå»ºè¡¨æ³•å¯ä»¥ç”Ÿæˆåˆ†åŒºè¡¨)</strong></p>
<p>LIKEå½¢å¼çš„CREATE TABLEå…è®¸æ‚¨ç²¾ç¡®åœ°å¤åˆ¶ç°æœ‰è¡¨å®šä¹‰ï¼ˆè€Œæ— éœ€å¤åˆ¶å…¶æ•°æ®ï¼‰ã€‚<br>ä¸CTASç›¸æ¯”ï¼Œä»¥ä¸‹è¯­å¥åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„empty_key_value_storeè¡¨ï¼Œå®ƒçš„å®šä¹‰åœ¨è¡¨åä»¥å¤–çš„æ‰€æœ‰ç»†èŠ‚ä¸Šä¸ç°æœ‰key_value_storeå®Œå…¨åŒ¹é…ã€‚ æ–°è¡¨ä¸åŒ…å«ä»»ä½•è¡Œã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE empty_key_value_store</span><br><span class="line">LIKE key_value_store [TBLPROPERTIES (property_name=property_value, ...)];</span><br></pre></td></tr></table></figure>
<p>åœ¨Hive 0.8.0ä¹‹å‰ï¼ŒCREATE TABLE LIKE view_nameå°†å¤åˆ¶è¯¥è§†å›¾ã€‚ åœ¨Hive 0.8.0å’Œæ›´é«˜ç‰ˆæœ¬ä¸­ï¼ŒCREATE TABLE LIKE view_nameé€šè¿‡ä½¿ç”¨view_name schemaï¼ˆå­—æ®µ(fields)å’Œåˆ†åŒºåˆ—(partition columns)ï¼‰, ä½¿ç”¨SerDeå’Œæ–‡ä»¶æ ¼å¼çš„é»˜è®¤å€¼æ¥åˆ›å»ºä¸€ä¸ªè¡¨ã€‚</p>
<p>æ³¨ï¼šä¸Šé¢è¯­å¥ä¸­å¦‚æœä¸ä½¿ç”¨ EXTERNAL å…³é”®å­—ï¼Œè‹¥æºè¡¨æ˜¯å¤–éƒ¨è¡¨çš„è¯ï¼Œç”Ÿæˆçš„æ–°è¡¨ä¹Ÿå°†æ˜¯å¤–éƒ¨è¡¨ï¼›è‹¥æºè¡¨æ˜¯å†…éƒ¨è¡¨çš„è¯ï¼Œç”Ÿæˆçš„æ–°è¡¨ä¹Ÿå°†æ˜¯å†…éƒ¨è¡¨ã€‚è‹¥è¯­å¥ä¸­åŒ…å« EXTERNAL å…³é”®å­—ä¸”æºè¡¨æ˜¯å†…éƒ¨è¡¨çš„è¯ï¼Œç”Ÿæˆçš„æ–°è¡¨å°†æ˜¯å¤–éƒ¨è¡¨ã€‚å³ä½¿åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼ŒLOCATION å­å¥åŒæ ·æ˜¯å¯é€‰çš„ã€‚</p>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create table t4 like t2;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥å‘ç°ï¼Œä¸ä¼šæ‰§è¡ŒMapReduceï¼Œä¸”è¡¨ç»“æ„å’Œt2å®Œå…¨ä¸€æ ·ï¼Œä½†æ˜¯æ²¡æœ‰æ•°æ®ã€‚</p>
<p><img src="/2020/01/12/Hiveä»‹ç»/1603614353762.png" alt="1603614353762"></p>
<h2 id="4-Hiveä¸­è¡¨çš„ç±»å‹"><a href="#4-Hiveä¸­è¡¨çš„ç±»å‹" class="headerlink" title="4. Hiveä¸­è¡¨çš„ç±»å‹"></a>4. Hiveä¸­è¡¨çš„ç±»å‹</h2><p>Hiveä¸­æœ‰5ç§è¡¨ï¼šå†…éƒ¨è¡¨ï¼Œå¤–éƒ¨è¡¨ï¼Œä¸´æ—¶è¡¨ï¼Œåˆ†åŒºè¡¨ï¼Œæ¡¶è¡¨ï¼ˆåˆ†æ¡¶è¡¨ï¼‰</p>
<h3 id="4-1-å†…éƒ¨è¡¨ä¸å¤–éƒ¨è¡¨"><a href="#4-1-å†…éƒ¨è¡¨ä¸å¤–éƒ¨è¡¨" class="headerlink" title="4.1 å†…éƒ¨è¡¨ä¸å¤–éƒ¨è¡¨"></a><span id="jump4.1">4.1 å†…éƒ¨è¡¨ä¸å¤–éƒ¨è¡¨</span></h3><p>ä¸ä½¿ç”¨ <code>EXTERNAL</code> åˆ›å»ºçš„è¡¨ç§°ä¸ºç®¡ç†è¡¨ (ä¹Ÿå«åšå†…éƒ¨è¡¨) (managed table)ï¼Œå› ä¸ºHiveç®¡ç†å®ƒçš„æ•°æ®ã€‚è‹¥è¦ç¡®å®šä¸€ä¸ªè¡¨æ˜¯å†…éƒ¨è¡¨è¿˜æ˜¯å¤–éƒ¨è¡¨ï¼Œä½¿ç”¨ <a href="https://cwiki.apache.org/confluence/display/Hive/Managed+vs.+External+Tables#Managedvs.ExternalTables-DescribeTable/View/Column" target="_blank" rel="noopener">DESCRIBE FORMATTED table_name</a> å¯ä»¥å¾—åˆ°è¡¨çš„ç±»å‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Table Type: MANAGED_TABLE æˆ–è€… EXTERNAL_TABLE</span><br></pre></td></tr></table></figure>
<p>ï¼ˆæ³¨ï¼šæ­¤å‘½ä»¤è¿˜ä¼šæ˜¾ç¤ºè®¸å¤šå…¶ä»–ä¿¡æ¯ï¼Œä¾‹å¦‚è¡¨çš„åˆ›å»ºäººï¼Œåˆ›å»ºæ—¶é—´ï¼Œlocationç­‰ç­‰ï¼‰</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒHiveåˆ›å»ºå†…éƒ¨è¡¨ï¼Œå…¶ä¸­æ–‡ä»¶ã€å…ƒæ•°æ®å’Œç»Ÿè®¡ä¿¡æ¯ç”±å†…éƒ¨Hiveè¿›ç¨‹ç®¡ç† ã€‚ æœ‰å…³å†…éƒ¨è¡¨ä¸å¤–éƒ¨è¡¨ä¹‹é—´å·®å¼‚çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… <a href="https://cwiki.apache.org/confluence/display/Hive/Managed+vs.+External+Tables" target="_blank" rel="noopener">Managed vs. External Tables</a>ã€‚</p>
<h4 id="4-1-1-Feature-comparison"><a href="#4-1-1-Feature-comparison" class="headerlink" title="4.1.1 Feature comparison"></a>4.1.1 Feature comparison</h4><ul>
<li>ARCHIVE/UNARCHIVE/TRUNCATE/MERGE/CONCATENATE only work for managed tables</li>
<li>DROP deletes data for managed tables while it only deletes metadata for external ones</li>
<li>ACID/Transactional only works for managed tables</li>
<li><a href="https://issues.apache.org/jira/browse/HIVE-18513" target="_blank" rel="noopener">Query Results Caching</a> only works for managed tables</li>
<li>Only the RELY constraint is allowed on external tables</li>
<li>Some Materialized View features only work on managed tables</li>
</ul>
<h4 id="4-1-2-å†…éƒ¨è¡¨ï¼ˆManaged-Tableï¼‰"><a href="#4-1-2-å†…éƒ¨è¡¨ï¼ˆManaged-Tableï¼‰" class="headerlink" title="4.1.2 å†…éƒ¨è¡¨ï¼ˆManaged Tableï¼‰"></a>4.1.2 å†…éƒ¨è¡¨ï¼ˆManaged Tableï¼‰</h4><p>A managed table is stored under the <a href="https://cwiki.apache.org/confluence/display/Hive/Configuration+Properties#ConfigurationProperties-hive.metastore.warehouse.dir" target="_blank" rel="noopener">hive.metastore.warehouse.dir</a> path property, by default in a folder path similar to <code>/user/hive/warehouse/databasename.db/tablename/</code>. The default location can be overridden by the <code>location</code> property during table creation. If a managed table or partition is dropped, the data and metadata associated with that table or partition are deleted. If the PURGE option is not specified, the data is moved to a trash folder for a defined duration.</p>
<p>Use managed tables when Hive should manage the lifecycle of the table, or when generating temporary tables.</p>
<p>å†…éƒ¨è¡¨çš„ä¸»è¦é—®é¢˜æ˜¯åªèƒ½ç”¨ Hive è®¿é—®ï¼Œä¸æ–¹ä¾¿å’Œå…¶ä»–ç³»ç»Ÿå…±äº«æ•°æ®ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸€ä»½ç”± Pig æˆ–å…¶ä»–å·¥å…·åˆ›å»ºå¹¶ä¸”ä¸»è¦ç”±è¿™ä¸€å·¥å…·ä½¿ç”¨çš„æ•°æ®ï¼ŒåŒæ—¶å¸Œæœ›ä½¿ç”¨ Hive åœ¨è¿™ä»½æ•°æ®ä¸Šæ‰§è¡Œä¸€äº›æŸ¥è¯¢ï¼Œå¯æ˜¯å¹¶æ²¡æœ‰ç»™äºˆ Hive å¯¹æ•°æ®çš„æ‰€æœ‰æƒï¼Œè¿™æ—¶å°±ä¸èƒ½ä½¿ç”¨å†…éƒ¨è¡¨äº†ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå¤–éƒ¨è¡¨æŒ‡å‘è¿™ä»½æ•°æ®ï¼Œè€Œå¹¶ä¸éœ€è¦å¯¹å…¶å…·æœ‰æ‰€æœ‰æƒã€‚</p>
<p>åˆ é™¤å†…éƒ¨è¡¨ä¼šåŒæ—¶åˆ é™¤å­˜å‚¨æ•°æ®å’Œå…ƒæ•°æ®ã€‚</p>
<p><strong>å»ºè¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å»ºè¡¨æ–¹å¼ä¸€</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1(</span><br><span class="line">    <span class="keyword">id</span>	<span class="built_in">INT</span>,</span><br><span class="line">    <span class="keyword">name</span> <span class="keyword">STRING</span>,</span><br><span class="line">    age <span class="built_in">INT</span>,</span><br><span class="line">    gfs <span class="built_in">ARRAY</span>&lt;<span class="keyword">STRING</span>&gt;,</span><br><span class="line">    address <span class="keyword">MAP</span>&lt;<span class="keyword">STRING</span>,<span class="keyword">STRING</span>&gt;,</span><br><span class="line">    info <span class="keyword">STRUCT</span>&lt;country:<span class="keyword">String</span>,province:<span class="keyword">String</span>,shi:<span class="keyword">String</span>&gt;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> <span class="keyword">DELIMITED</span> </span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">' '</span> </span><br><span class="line">COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span></span><br><span class="line"><span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">':'</span> </span><br><span class="line"><span class="keyword">LINES</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\n'</span></span><br><span class="line">LOCATION <span class="string">"/test"</span>; <span class="comment">-- å¯ä»¥è®¾ç½®æºæ•°æ®çš„ä½ç½®ï¼Œè‹¥ä¸è®¾ç½®é»˜è®¤å°±åœ¨Hiveçš„å·¥ä½œç›®å½•åŒºï¼ˆå…³äºè¡¨çš„å­˜æ”¾ä½ç½®ï¼Œå¯ä½¿ç”¨ desc formatted tablename è¿›è¡ŒæŸ¥çœ‹ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å»ºè¡¨æ–¹å¼äºŒ</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> gfstbl1 <span class="keyword">like</span> gfstbl; <span class="comment">-- åªæ˜¯åˆ›å»ºè¡¨ç»“æ„</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- å»ºè¡¨æ–¹å¼ä¸‰</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> gfstbl2 <span class="keyword">AS</span> <span class="keyword">SELECT</span> <span class="keyword">id</span>,<span class="keyword">name</span>,gfs,address <span class="keyword">from</span> gfstbl; </span><br><span class="line"><span class="comment">-- ä¼šåˆ›å»ºç›¸åº”çš„è¡¨ç»“æ„ï¼Œå¹¶ä¸”æ’å…¥æ•°æ®ï¼Œç›¸å½“äºå®Œæ•´çš„èµ‹å€¼</span></span><br></pre></td></tr></table></figure>
<p>å…³äºå»ºè¡¨çš„æ›´è¯¦ç»†ä»‹ç»è§ <a href="#jump3">3. Hiveå»ºè¡¨è¯­å¥</a></p>
<p><strong>åŠ è½½æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/root/gfs.txt'</span> <span class="keyword">into</span> <span class="keyword">table</span> gfstbl;</span><br></pre></td></tr></table></figure>
<p>æ›´è¯¦ç»†ä»‹ç»è§ <a href="#jump5">5. å‘Hiveè¡¨ç§æ’å…¥æ•°æ®</a></p>
<p><strong>æŸ¥çœ‹è¡¨æè¿°ä¿¡æ¯ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DESCRIBE</span> [<span class="keyword">EXTENDED</span>|FORMATTED] table_name</span><br><span class="line">å¦‚ <span class="keyword">DESCRIBE</span> FORMATTED gfstbl;</span><br></pre></td></tr></table></figure>
<p>DESCRIBEæ˜¾ç¤ºåˆ—çš„åˆ—è¡¨ï¼ˆthe list of columnsï¼‰ï¼ŒåŒ…æ‹¬ç»™å®šè¡¨çš„åˆ†åŒºåˆ—ï¼ˆpartition columnsï¼‰ã€‚ å¦‚æœæŒ‡å®šäº†EXTENDEDå…³é”®å­—ï¼Œåˆ™å®ƒå°†ä»¥Thriftåºåˆ—åŒ–å½¢å¼æ˜¾ç¤ºè¡¨çš„æ‰€æœ‰å…ƒæ•°æ®ã€‚ è¿™é€šå¸¸åªåœ¨è°ƒè¯•æ—¶æœ‰ç”¨ï¼Œè€Œä¸é€‚ç”¨äºä¸€èˆ¬ä½¿ç”¨ã€‚ å¦‚æœæŒ‡å®šäº†FORMATTEDå…³é”®å­—ï¼Œåˆ™å®ƒå°†ä»¥è¡¨æ ¼æ ¼å¼æ˜¾ç¤ºå…ƒæ•°æ®ã€‚</p>
<h4 id="4-1-3-å¤–éƒ¨è¡¨ï¼ˆExternal-Tableï¼‰"><a href="#4-1-3-å¤–éƒ¨è¡¨ï¼ˆExternal-Tableï¼‰" class="headerlink" title="4.1.3 å¤–éƒ¨è¡¨ï¼ˆExternal Tableï¼‰"></a>4.1.3 å¤–éƒ¨è¡¨ï¼ˆExternal Tableï¼‰</h4><p>An external table describes the metadata/schema on external files. External table files can be accessed and managed by processes outside of Hive. External tables can access data stored in sources such as Azure Storage Volumes (ASV) or remote HDFS locations. If the structure or partitioning of an external table is changed, an <a href="https://cwiki.apache.org/confluence/display/Hive/Managed+vs.+External+Tables#Managedvs.ExternalTables-RecoverPartitions(MSCKREPAIRTABLE" target="_blank" rel="noopener">MSCK REPAIR TABLE table_name</a>) statement can be used to refresh metadata information.</p>
<p>Use external tables when files are already present or in remote locations, and the files should remain even if the table is dropped.</p>
<p>å¤–éƒ¨è¡¨æ–¹ä¾¿å¯¹å·²æœ‰æ•°æ®çš„é›†æˆã€‚å› ä¸ºè¡¨æ˜¯å¤–éƒ¨çš„ï¼Œæ‰€ä»¥ Hive å¹¶ä¸è®¤ä¸ºå…¶å®Œå…¨æ‹¥æœ‰è¿™ä¸ªè¡¨çš„æ•°æ®ã€‚åœ¨å¯¹å¤–éƒ¨è¡¨æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶ï¼Œåªæ˜¯åˆ é™¤æ‰æè¿°è¡¨çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œå¹¶ä¸ä¼šåˆ é™¤è¡¨æ•°æ®ã€‚</p>
<p>æ•°æ®å­˜å‚¨ä½ç½®ç”±ç”¨æˆ·è‡ªå·±æŒ‡å®šï¼Œ<strong>ç”±HDFSç®¡ç†ï¼Œåˆ é™¤å¤–éƒ¨è¡¨æ—¶ä»…ä»…ä¼šåˆ é™¤å…ƒæ•°æ®ï¼Œå­˜å‚¨æ•°æ®ä¸ä¼šå—åˆ°å½±å“ã€‚</strong></p>
<ul>
<li>é€‚ç”¨æƒ…å½¢ï¼š<br>å½“ä¸€ä»½æ—¥å¿—éœ€è¦å¤šä¸ªå°ç»„ä¸€èµ·åˆ†æï¼Œåˆ†æå®Œäº†ä¹‹ååˆ›å»ºçš„è¡¨å°±å¯ä»¥åˆ é™¤äº†ã€‚ä½†æ˜¯æ™®é€šçš„è¡¨åˆ é™¤çš„åŒæ—¶ä¹Ÿä¼šæŠŠæ•°æ®åˆ é™¤ï¼Œè¿™æ ·å°±ä¼šå½±å“åˆ°å…¶ä»–å°ç»„çš„åˆ†æï¼Œè€Œä¸”æ—¥å¿—æ•°æ®ä¹Ÿä¸èƒ½éšä¾¿åˆ é™¤ã€‚æ‰€ä»¥ï¼Œéœ€è¦å¤–éƒ¨è¡¨ï¼Œåˆ é™¤å¤–éƒ¨è¡¨ï¼Œä¸ä¼šåˆ é™¤å¯¹åº”çš„HDFSä¸Šçš„æ•°æ®ã€‚</li>
</ul>
<p><strong>å»ºè¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> wc_external (</span><br><span class="line">    word1 <span class="keyword">STRING</span>, </span><br><span class="line">    word2 <span class="keyword">STRING</span></span><br><span class="line">) </span><br><span class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> <span class="keyword">DELIMITED</span> </span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">' '</span> </span><br><span class="line">location <span class="string">'/test/external'</span>; <span class="comment">-- locationå¯åŠ å¯ä¸åŠ ï¼Œä¸åŠ locationé»˜è®¤æ˜¯åœ¨hiveçš„å·¥ä½œç›®å½•åŒº</span></span><br></pre></td></tr></table></figure>
<h4 id="4-1-4-å†…éƒ¨è¡¨ä¸å¤–éƒ¨è¡¨çš„åŒºåˆ«"><a href="#4-1-4-å†…éƒ¨è¡¨ä¸å¤–éƒ¨è¡¨çš„åŒºåˆ«" class="headerlink" title="4.1.4 å†…éƒ¨è¡¨ä¸å¤–éƒ¨è¡¨çš„åŒºåˆ«"></a>4.1.4 å†…éƒ¨è¡¨ä¸å¤–éƒ¨è¡¨çš„åŒºåˆ«</h4><ul>
<li>å†…éƒ¨è¡¨æ•°æ®ç”±Hiveè‡ªèº«ç®¡ç†ï¼Œå¤–éƒ¨è¡¨æ•°æ®ç”±HDFSç®¡ç†ï¼›</li>
<li>å†…éƒ¨è¡¨æ•°æ®å­˜å‚¨çš„ä½ç½®æ˜¯hive.metastore.warehouse.dirï¼ˆé»˜è®¤ï¼š/user/hive/warehouseï¼‰ï¼Œå¤–éƒ¨è¡¨æ•°æ®çš„å­˜å‚¨ä½ç½®ç”±è‡ªå·±åˆ¶å®šï¼›</li>
<li>å¯¹å†…éƒ¨è¡¨çš„ä¿®æ”¹ä¼šå°†ä¿®æ”¹ç›´æ¥åŒæ­¥ç»™å…ƒæ•°æ®ï¼Œè€Œå¯¹å¤–éƒ¨è¡¨çš„è¡¨ç»“æ„å’Œåˆ†åŒºè¿›è¡Œä¿®æ”¹ï¼Œåˆ™éœ€è¦ä¿®å¤ï¼ˆMSCK REPAIR TABLE table_name;ï¼‰</li>
<li>åˆ›å»ºè¡¨æ—¶ï¼šåˆ›å»ºå†…éƒ¨è¡¨æ—¶ï¼Œä¼šå°†æ•°æ®ç§»åŠ¨åˆ°æ•°æ®ä»“åº“æŒ‡å‘çš„è·¯å¾„ï¼›è‹¥åˆ›å»ºå¤–éƒ¨è¡¨ï¼Œä»…è®°å½•æ•°æ®æ‰€åœ¨çš„è·¯å¾„ï¼Œ ä¸å¯¹æ•°æ®çš„ä½ç½®åšä»»ä½•æ”¹å˜ã€‚</li>
<li>åˆ é™¤è¡¨æ—¶ï¼šåœ¨åˆ é™¤è¡¨çš„æ—¶å€™ï¼Œå†…éƒ¨è¡¨çš„å…ƒæ•°æ®å’Œæ•°æ®ä¼šè¢«ä¸€èµ·åˆ é™¤ï¼Œè€Œå¤–éƒ¨è¡¨åªåˆ é™¤å…ƒæ•°æ®ï¼Œä¸åˆ é™¤æ•°æ®ï¼ˆHDFSä¸Šçš„æ–‡ä»¶ä¸ä¼šè¢«åˆ é™¤ï¼‰ã€‚è¿™æ ·å¤–éƒ¨è¡¨ç›¸å¯¹æ¥è¯´æ›´åŠ å®‰å…¨äº›ï¼Œæ•°æ®ç»„ç»‡ä¹Ÿæ›´åŠ çµæ´»ï¼Œæ–¹ä¾¿å…±äº«æºæ•°æ®</li>
</ul>
<h3 id="4-2-ä¸´æ—¶è¡¨ï¼ˆTemporary-Tableï¼‰"><a href="#4-2-ä¸´æ—¶è¡¨ï¼ˆTemporary-Tableï¼‰" class="headerlink" title="4.2 ä¸´æ—¶è¡¨ï¼ˆTemporary Tableï¼‰"></a>4.2 ä¸´æ—¶è¡¨ï¼ˆTemporary Tableï¼‰</h3><p>åœ¨å½“å‰ä¼šè¯æœŸé—´å­˜åœ¨ï¼Œä¼šè¯ç»“æŸåè‡ªåŠ¨é”€æ¯ã€‚</p>
<ul>
<li>é€‚ç”¨æƒ…å½¢<br>ä¸´æ—¶åˆ†æï¼Œåœ¨å…³é—­hiveå®¢æˆ·ç«¯åï¼Œä¸´æ—¶è¡¨å°±ä¼šæ¶ˆå¤±ã€‚ä¸»è¦ç”¨äºå­˜å‚¨ä¸é‡è¦çš„ä¸­é—´ç»“æœé›†ï¼Œä¸é‡è¦çš„è¡¨ã€‚</li>
</ul>
<p>ä¸´æ—¶è¡¨å…·æœ‰ä»¥ä¸‹é™åˆ¶ï¼š</p>
<ul>
<li>ä¸æ”¯æŒåˆ†åŒºåˆ—ã€‚</li>
<li>ä¸æ”¯æŒåˆ›å»ºç´¢å¼•ã€‚</li>
</ul>
<p><strong>å»ºè¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">TEMPORARY</span> <span class="keyword">table</span> ttabc(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">Int</span>,</span><br><span class="line">    <span class="keyword">name</span> <span class="keyword">String</span></span><br><span class="line">) </span><br><span class="line"><span class="comment">-- ä¸´æ—¶è¡¨çš„å£°æ˜å‘¨æœŸæ˜¯ä¸€æ¬¡ä¼šè¯ï¼Œè¿›å…¥hive shellåˆ›å»ºä¸€å¼ è¡¨ï¼Œå…³é—­shellåï¼Œè¡¨ä¸¢å¤±ï¼Œä¸´æ—¶è¡¨ä¸æ”¯æŒåˆ†åŒº</span></span><br></pre></td></tr></table></figure>
<p><strong>å»ºè¡¨å¹¶åŠ è½½æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">TEMPORARY</span> <span class="keyword">table</span> dept_tmp(  </span><br><span class="line">    deptno <span class="built_in">int</span>,  </span><br><span class="line">    dname <span class="keyword">string</span>,</span><br><span class="line">    loc <span class="keyword">string</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span>  </span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/opt/datas/dept.txt'</span> <span class="keyword">into</span> <span class="keyword">table</span> dept_tmp;</span><br></pre></td></tr></table></figure>
<p><strong>æŸ¥çœ‹locationä¿¡æ¯ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">desc formatted dept_tmp;</span><br><span class="line">Location:               hdfs://172.19.199.187:8020/tmp/hive/hadoop/68174383-f427-4629-9707-0ab1c9b07726/_tmp_space.db/d872efec-1294-48b0-9071-31cf98d46400    </span><br><span class="line">Table Type:             MANAGED_TABLE</span><br></pre></td></tr></table></figure>
<h3 id="4-3-åˆ†åŒºè¡¨ï¼ˆPartitioned-Tableï¼‰"><a href="#4-3-åˆ†åŒºè¡¨ï¼ˆPartitioned-Tableï¼‰" class="headerlink" title="4.3 åˆ†åŒºè¡¨ï¼ˆPartitioned Tableï¼‰"></a><span id="jump4.4">4.3 åˆ†åŒºè¡¨ï¼ˆPartitioned Tableï¼‰</span></h3><p>å¯ä»¥ä½¿ç”¨ <code>PARTITIONED BY</code> å­å¥åˆ›å»ºåˆ†åŒºè¡¨ã€‚ ä¸€ä¸ªè¡¨å¯ä»¥å…·æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªåˆ†åŒºåˆ—ï¼Œå¹¶ä¸ºåˆ†åŒºåˆ—ä¸­çš„æ¯ä¸ªä¸åŒå€¼ç»„åˆåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æ•°æ®ç›®å½•ã€‚ æ­¤å¤–ï¼Œå¯ä»¥ä½¿ç”¨ <code>CLUSTERED BY</code> åˆ—å¯¹è¡¨æˆ–åˆ†åŒºè¿›è¡Œå­˜å‚¨ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ <code>SORT BY</code> åˆ—åœ¨è¯¥å­˜å‚¨åŒºä¸­å¯¹æ•°æ®è¿›è¡Œæ’åºï¼ˆtables or partitions can be bucketed using CLUSTERED BY columns, and data can be sorted within that bucket via SORT BY columns. ï¼‰ã€‚ è¿™æ ·å¯ä»¥æé«˜æŸäº›æŸ¥è¯¢çš„æ€§èƒ½ã€‚</p>
<blockquote>
<p>æ›´å¤šå…³äºbucket çš„å†…å®¹è§ <a href="#jump4.4">4.4 åˆ†æ¡¶è¡¨ï¼ˆBucket Tablesï¼‰ </a></p>
</blockquote>
<p>å¦‚æœåœ¨åˆ›å»ºåˆ†åŒºè¡¨æ—¶æ”¶åˆ°ä»¥ä¸‹é”™è¯¯æ¶ˆæ¯ï¼šâ€œ FAILED: Error in semantic analysis: Column repeated in partitioning columnsâ€ï¼Œåˆ™è¡¨ç¤ºæ‚¨è¯•å›¾å°†åˆ†åŒºåˆ—åŒ…å«åœ¨è¡¨æœ¬èº«çš„æ•°æ®ä¸­ã€‚ æ‚¨å¯èƒ½ç¡®å®å®šä¹‰äº†è¯¥åˆ—ï¼Œä½†æ˜¯ï¼Œæ‚¨åˆ›å»ºçš„åˆ†åŒºå°†åˆ›å»ºä¸€ä¸ªå¯æŸ¥è¯¢çš„ä¼ªåˆ—ï¼Œå› æ­¤æ‚¨å¿…é¡»å°†è¡¨åˆ—é‡å‘½åä¸ºå…¶ä»–åç§°ï¼ˆç”¨æˆ·ä¸åº”åœ¨å…¶ä¸ŠæŸ¥è¯¢ï¼ï¼‰ã€‚</p>
<p>(You probably really do have the column defined. However, the partition you create makes a pseudocolumn on which you can query, so you must rename your table column to something else (that users should not query on!).)</p>
<p>ä¾‹å¦‚ï¼Œå‡è®¾åŸå§‹æœªåˆ†åŒºè¡¨å…·æœ‰ä¸‰åˆ—ï¼šidï¼Œdateå’Œnameã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id int,</span><br><span class="line">date date,</span><br><span class="line">name varchar</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨æ‚¨è¦æŒ‰æ—¥æœŸåˆ†åŒºã€‚ æ‚¨çš„Hiveå®šä¹‰å¯ä»¥ä½¿ç”¨â€œ dtDontQueryâ€ä½œä¸ºåˆ—åï¼Œä»¥ä¾¿å¯ä»¥å°†â€œ dateâ€ç”¨äºåˆ†åŒºï¼ˆå’ŒæŸ¥è¯¢ï¼‰ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> table_name ( </span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line">	dtDontQuery <span class="keyword">string</span>,</span><br><span class="line">	<span class="keyword">name</span> <span class="keyword">string</span></span><br><span class="line">)</span><br><span class="line">partitioned <span class="keyword">by</span> (<span class="built_in">date</span> <span class="keyword">string</span>)</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œæ‚¨çš„ç”¨æˆ·ä»å°†æŸ¥è¯¢<code>where date =&#39;...&#39;</code>ï¼Œä½†ç¬¬äºŒåˆ—dtDontQueryå°†ä¿ç•™åŸå§‹å€¼ã€‚</p>
<hr>
<p>åˆ†åŒºè¡¨å°†æ•°æ®æŒ‰ç…§æŸä¸ªå­—æ®µæˆ–è€…å…³é”®å­—åˆ†æˆå¤šä¸ªå­ç›®å½•æ¥å­˜å‚¨ï¼Œé˜²æ­¢æš´åŠ›æ‰«æå…¨è¡¨ã€‚</p>
<ul>
<li><p>é€‚ç”¨æƒ…å½¢</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">logs</span> <span class="keyword">where</span> <span class="built_in">date</span> = <span class="string">'20171209'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>æ™®é€šè¡¨æ‰§è¡Œæµç¨‹ï¼šå¯¹å…¨è¡¨çš„æ•°æ®è¿›è¡ŒæŸ¥è¯¢ï¼Œç„¶åè¿›è¡Œè¿‡æ»¤æ“ä½œã€‚</li>
<li>åˆ†åŒºè¡¨æ‰§è¡Œæµç¨‹ï¼šç›´æ¥åŠ è½½å¯¹åº”æ–‡ä»¶è·¯å¾„ä¸‹çš„æ•°æ®ã€‚</li>
</ul>
<p>é€‚ç”¨äºå¤§æ•°æ®é‡ï¼Œå¯ä»¥é€šè¿‡åˆ†åŒºå¿«é€Ÿå®šä½éœ€è¦æŸ¥è¯¢çš„æ•°æ®ï¼Œ<strong>åˆ†åŒºè¡¨çš„ä½œç”¨ä¸»è¦æ˜¯æé«˜æŸ¥è¯¢æ£€ç´¢çš„æ•ˆç‡ ã€‚</strong></p>
</li>
</ul>
<p>åˆ†åŒºè¡¨çš„ä¼˜åŠ¿ä½“ç°åœ¨å¯ç»´æŠ¤æ€§å’Œæ€§èƒ½ä¸¤æ–¹é¢ï¼Œè€Œä¸”åˆ†åŒºè¡¨è¿˜å¯ä»¥å°†æ•°æ®ä»¥ä¸€ç§ç¬¦åˆä¸šåŠ¡é€»è¾‘çš„æ–¹å¼è¿›è¡Œç»„ç»‡ï¼Œå› æ­¤æ˜¯æ•°æ®ä»“åº“ä¸­ç»å¸¸ä½¿ç”¨çš„ä¸€ç§æŠ€æœ¯ã€‚å†…éƒ¨è¡¨å’Œå¤–éƒ¨è¡¨éƒ½å¯ä»¥åˆ›å»ºç›¸åº”çš„åˆ†åŒºè¡¨ï¼Œåˆ†åˆ«ç§°ä¹‹ä¸ºå†…éƒ¨åˆ†åŒºè¡¨å’Œå¤–éƒ¨åˆ†åŒºè¡¨ã€‚</p>
<p>å…ˆçœ‹ä¸€ä¸ªå†…éƒ¨åˆ†åŒºè¡¨çš„ä¾‹å­ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> page_view(</span><br><span class="line">    viewtime <span class="built_in">int</span>,</span><br><span class="line">	userid <span class="built_in">bigint</span>,</span><br><span class="line">	page_url <span class="keyword">string</span>,</span><br><span class="line">	referrer_url <span class="keyword">string</span>,</span><br><span class="line">	ip <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'ip address of the user'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">'this is the page view table'</span></span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (dt <span class="keyword">string</span>, country <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> <span class="keyword">DELIMITED</span> </span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\001'</span></span><br><span class="line"><span class="keyword">STORED</span> <span class="keyword">AS</span> SEQUENCEFILE;</span><br></pre></td></tr></table></figure>
<p><code>CREATE TABLE</code> è¯­å¥çš„ <code>PARTITIONED BY</code> å­å¥ç”¨äºåˆ›å»ºåˆ†åŒºè¡¨ã€‚ä¸Šé¢çš„è¯­å¥åˆ›å»ºä¸€ä¸ªåä¸º page_view çš„åˆ†åŒºè¡¨ã€‚è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„é¡µé¢æµè§ˆè®°å½•è¡¨ï¼ŒåŒ…å«æµè§ˆæ—¶é—´ã€æµè§ˆç”¨æˆ·IDã€æµè§ˆé¡µé¢çš„URLã€ä¸Šä¸€ä¸ªè®¿é—®çš„URLå’Œç”¨æˆ·çš„IPåœ°å€äº”ä¸ªå­—æ®µã€‚è¯¥è¡¨ä»¥æ—¥æœŸå’Œå›½å®¶ä½œä¸ºåˆ†åŒºå­—æ®µï¼Œå­˜å‚¨ä¸ºSEQUENCEFILEæ–‡ä»¶æ ¼å¼ã€‚æ–‡ä»¶ä¸­çš„æ•°æ®åˆ†åˆ«ä½¿ç”¨é»˜è®¤çš„Ctrl-Aå’Œæ¢è¡Œç¬¦ä½œä¸ºåˆ—å’Œè¡Œçš„åˆ†éš”ç¬¦ã€‚</p>
<p>ä½¿ç”¨ DESCRIBE FORMATTED å‘½ä»¤ä¼šæ˜¾ç¤ºå‡ºåˆ†åŒºé”®ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DESCRIBE</span> FORMATTED page_view;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºä¿¡æ¯ä¸­æŠŠè¡¨å­—æ®µå’Œåˆ†åŒºå­—æ®µåˆ†å¼€æ˜¾ç¤ºã€‚</p>
<p>åˆ†åŒºè¡¨æ”¹å˜äº† Hive å¯¹æ•°æ®å­˜å‚¨çš„ç»„ç»‡æ–¹å¼ã€‚å¦‚æœæ˜¯ä¸€ä¸ªéåˆ†åŒºè¡¨ï¼Œé‚£ä¹ˆåªä¼šæœ‰ä¸€ä¸ªpage_viewç›®å½•ä¸ä¹‹å¯¹åº”ï¼Œè€Œå¯¹äºåˆ†åŒºè¡¨ï¼Œå½“å‘è¡¨ä¸­è£…è½½æ•°æ®åï¼ŒHive å°†ä¼šåˆ›å»ºå¥½å¯ä»¥åæ˜ åˆ†åŒºç»“æ„çš„å­ç›®å½•ã€‚</p>
<p>å¯¹æ•°æ®è¿›è¡Œåˆ†åŒºï¼Œæœ€é‡è¦çš„åŸå› å°±æ˜¯ä¸ºäº†æ›´å¿«åœ°æŸ¥è¯¢ã€‚å¦‚æœç”¨æˆ·çš„æŸ¥è¯¢åŒ…å«äº† <code>where dt=&#39;...&#39; and country=&#39;...&#39;</code> è¿™æ ·çš„æ¡ä»¶ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨åªéœ€è¦æ‰«æä¸€ä¸ªåˆ†åŒºç›®å½•å³å¯ã€‚</p>
<p><strong>é™æ€åˆ†åŒºè¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> day_hour_table (</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">int</span>, </span><br><span class="line">    <span class="keyword">content</span> <span class="keyword">string</span></span><br><span class="line">) </span><br><span class="line">partitioned <span class="keyword">by</span> (dt <span class="built_in">int</span>, <span class="keyword">hour</span> <span class="built_in">int</span>) </span><br><span class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> <span class="keyword">DELIMITED</span> </span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\t'</span> ;</span><br></pre></td></tr></table></figure>
<p><strong>åŠ è½½æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- insertå•æ¡æ’å…¥çš„æ–¹å¼å¾€åˆ†åŒºè¡¨ä¸­æ’å…¥æ•°æ®ï¼š</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> day_hour_table <span class="keyword">partition</span>(dt=<span class="number">9</span>,<span class="keyword">hour</span>=<span class="number">1</span>) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">"a2 bc"</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> day_hour_table <span class="keyword">partition</span>(dt=<span class="number">9</span>,<span class="keyword">hour</span>=<span class="number">2</span>) <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">"a2 bc"</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> day_hour_table <span class="keyword">partition</span>(dt=<span class="number">8</span>,<span class="keyword">hour</span>=<span class="number">1</span>) <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">"a2 bc"</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> day_hour_table <span class="keyword">partition</span>(dt=<span class="number">8</span>,<span class="keyword">hour</span>=<span class="number">2</span>) <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">"a2 bc"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- loadæ‰¹é‡æ’å…¥çš„æ–¹å¼å¾€åˆ†åŒºè¡¨ä¸­æ’å…¥æ•°æ®ï¼š</span></span><br><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">"/root/ceshi"</span> <span class="keyword">into</span> <span class="keyword">table</span> day_table <span class="keyword">partition</span> (dt=<span class="number">10</span>,<span class="keyword">hour</span>=<span class="number">10</span>);</span><br></pre></td></tr></table></figure>
<p><strong>åˆ é™¤Hiveåˆ†åŒºè¡¨ä¸­çš„åˆ†åŒºï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> day_table <span class="keyword">DROP</span> <span class="keyword">PARTITION</span> (dt=<span class="number">10</span>,<span class="keyword">hour</span>=<span class="number">10</span>);</span><br></pre></td></tr></table></figure>
<p><strong>åˆ›å»º\æ·»åŠ åˆ†åŒºï¼š</strong></p>
<p>Syntax:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">ADD</span> [<span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] <span class="keyword">PARTITION</span> partition_spec [LOCATION <span class="string">'location'</span>]</span><br><span class="line">[, <span class="keyword">PARTITION</span> partition_spec [LOCATION <span class="string">'location'</span>], ...];</span><br><span class="line"></span><br><span class="line">partition_spec:</span><br><span class="line">	  : (partition_column = partition_col_value, partition_column = partition_col_value, ...)</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»ºä¸€ä¸ªç©ºåˆ†åŒºï¼š</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> day_hour_table <span class="keyword">ADD</span> <span class="keyword">PARTITION</span> (dt=<span class="number">10000</span>, <span class="keyword">hour</span>=<span class="number">2000</span>);</span><br><span class="line"><span class="comment">-- ç„¶åå°†æ•°æ®ä¸Šä¼ åˆ°ç©ºåˆ†åŒºå¯¹åº”çš„ç›®å½•ä¸‹ï¼Œåˆ†åŒºè¡¨ä¸­å°±ä¼šæ˜¾ç¤ºæ•°æ®</span></span><br><span class="line">hdfs dfs -put ........</span><br><span class="line"><span class="comment">-- æˆ–è€…ä¹Ÿå¯ç”¨ insert overwrite</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> day_hour_table <span class="keyword">partition</span>(dt=<span class="number">10000</span>, <span class="keyword">hour</span>=<span class="number">2000</span>)</span><br><span class="line"><span class="keyword">select</span> ...</span><br><span class="line"><span class="comment">-- åˆ›å»ºä¸€ä¸ªç©ºåˆ†åŒºå¹¶ä¸”å°†ç©ºåˆ†åŒºæŒ‡å‘æ•°æ®ä½ç½®ï¼š</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> day_hour_table <span class="keyword">ADD</span> <span class="keyword">PARTITION</span> (dt=<span class="number">10000</span>, <span class="keyword">hour</span>=<span class="number">2000</span>) location <span class="string">"/test"</span></span><br></pre></td></tr></table></figure>
<p><strong>åŠ¨æ€åˆ†åŒºè¡¨ï¼š</strong></p>
<p>åŠ¨æ€åˆ†åŒºè¡¨å’Œé™æ€åˆ†åŒºè¡¨å»ºè¡¨è¯­å¥ç›¸åŒï¼Œæ’å…¥æ•°æ®çš„æ–¹å¼ä¸åŒ</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.exec.dynamic.partition=<span class="literal">true</span>;</span><br><span class="line"><span class="keyword">set</span> hive.exec.dynamic.partition.mode=nonstrict;</span><br></pre></td></tr></table></figure>
<p>åŠ¨æ€åˆ†åŒºå¯ä»¥æ ¹æ®æ•°æ®æœ¬èº«çš„ç‰¹å¾è‡ªåŠ¨æ¥åˆ’åˆ†åˆ†åŒºï¼Œ<code>load data â€¦</code> åªæ˜¯å°†æ•°æ®ä¸Šä¼ åˆ°HDFSæŒ‡å®šç›®å½•ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨from insertçš„æ–¹å¼æ’å…¥æ•°æ®ï¼Œhiveæ‰ä¼šæ ¹æ®åˆ†åŒºè®¾ç½®è‡ªåŠ¨å°†æ•°æ®è¿›è¡Œåˆ†åŒºã€‚ï¼ˆè¯¦ç»†å†…å®¹è§ğŸ‘‡ï¼‰</p>
<p><strong>åŠ¨æ€åˆ†åŒºæ’å…¥ï¼ˆDynamic Partition Insertsï¼‰</strong></p>
<blockquote>
<p>å‚è€ƒ <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DML" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DML</a></p>
</blockquote>
<p>åœ¨åŠ¨æ€åˆ†åŒºæ’å…¥ä¸­ï¼Œç”¨æˆ·å¯ä»¥æä¾›éƒ¨åˆ†åˆ†åŒºè§„èŒƒï¼Œè¿™æ„å‘³ç€åªéœ€åœ¨PARTITIONå­å¥ä¸­æŒ‡å®šåˆ†åŒºåˆ—ååˆ—è¡¨ ( specifying the list of partition column names)ã€‚åˆ—å€¼æ˜¯å¯é€‰çš„ (The column values are optional)ã€‚å¦‚æœç»™å®šä¸€ä¸ªåˆ†åŒºåˆ—å€¼ (partition column value)ï¼Œæˆ‘ä»¬ç§°å…¶ä¸ºé™æ€åˆ†åŒºï¼Œå¦åˆ™ä¸ºåŠ¨æ€åˆ†åŒºã€‚æ¯ä¸ªåŠ¨æ€åˆ†åŒºåˆ—éƒ½æœ‰ä¸€ä¸ªæ¥è‡ªselectè¯­å¥çš„ç›¸åº”è¾“å…¥åˆ—ã€‚è¿™æ„å‘³ç€åŠ¨æ€åˆ†åŒºçš„åˆ›å»ºç”±è¾“å…¥åˆ—çš„å€¼å†³å®šã€‚åŠ¨æ€åˆ†åŒºåˆ—å¿…é¡»åœ¨SELECTè¯­å¥çš„åˆ—ä¸­æœ€åæŒ‡å®šï¼Œå¹¶ä¸”æŒ‰ç…§å®ƒä»¬åœ¨PARTITION()å­å¥ä¸­å‡ºç°çš„é¡ºåºæŒ‡å®šã€‚</p>
<blockquote>
<p>In the dynamic partition inserts, users can give partial partition specifications, which means just specifying the list of partition column names in the PARTITION clause. The column values are optional. If a partition column value is given, we call this a static partition, otherwise it is a dynamic partition. Each dynamic partition column has a corresponding input column from the select statement. This means that the dynamic partition creation is determined by the value of the input column. The dynamic partition columns must be <strong>specified last</strong> among the columns in the SELECT statement and <strong>in the same order</strong> in which they appear in the PARTITION() clause.</p>
</blockquote>
<p>As of Hive 3.0.0 (<a href="https://issues.apache.org/jira/browse/HIVE-19083" target="_blank" rel="noopener">HIVE-19083</a>) there is no need to specify dynamic partition columns. Hive will automatically generate partition specification if it is not specified.</p>
<style>
table th:first-of-type {
    width: 220px;
}
table th:nth-of-type(2) {
    width: 70px;
}
</style>

<div class="table-container">
<table>
<thead>
<tr>
<th>Configuration property</th>
<th>Default</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>hive.exec.dynamic.partition</code></td>
<td><code>true</code></td>
<td>Needs to be set to <code>true</code> to enable dynamic partition inserts</td>
</tr>
<tr>
<td><code>hive.exec.dynamic.partition.mode</code></td>
<td><code>strict</code></td>
<td>In <code>strict</code> mode, the user must specify at least one static partition in case the user accidentally overwrites all partitions, in <code>nonstrict</code> mode all partitions are allowed to be dynamic</td>
</tr>
<tr>
<td><code>hive.exec.max.dynamic.partitions.pernode</code></td>
<td>100</td>
<td>Maximum number of dynamic partitions allowed to be created in each mapper/reducer node</td>
</tr>
<tr>
<td><code>hive.exec.max.dynamic.partitions</code></td>
<td>1000</td>
<td>Maximum number of dynamic partitions allowed to be created in total</td>
</tr>
<tr>
<td><code>hive.exec.max.created.files</code></td>
<td>100000</td>
<td>Maximum number of HDFS files created by all mappers/reducers in a MapReduce job</td>
</tr>
<tr>
<td><code>hive.error.on.empty.partition</code></td>
<td><code>false</code></td>
<td>Whether to throw an exception if dynamic partition insert generates empty results</td>
</tr>
</tbody>
</table>
</div>
<p>ä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM page_view_stg pvs</span><br><span class="line">INSERT OVERWRITE TABLE page_view PARTITION(dt=&apos;2008-06-08&apos;, country)</span><br><span class="line">       SELECT pvs.viewTime, pvs.userid, pvs.page_url, pvs.referrer_url, null, null, pvs.ip, pvs.cnt</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œï¼Œcountry åˆ†åŒºå°†ç”±SELECTå­å¥çš„æœ€åä¸€åˆ—ï¼ˆå³pvs.cntï¼‰åŠ¨æ€åˆ›å»ºã€‚Note that the name is not used. åœ¨ nonstrict æ¨¡å¼ä¸‹ï¼Œthe <code>dt</code> partition could also be dynamically created.</p>
<p>å…³äº INSERT çš„è¯­æ³•è§ <a href="#jump5.2.1">5.2.1 INSERT INTO/OVERWRITE TABLE SELECT</a>.</p>
<h3 id="4-4-åˆ†æ¡¶è¡¨ï¼ˆBucked-Tablesï¼‰"><a href="#4-4-åˆ†æ¡¶è¡¨ï¼ˆBucked-Tablesï¼‰" class="headerlink" title="4.4 åˆ†æ¡¶è¡¨ï¼ˆBucked Tablesï¼‰"></a><span id="jump4.4">4.4 åˆ†æ¡¶è¡¨ï¼ˆBucked Tablesï¼‰</span></h3><p>å°†æ•°æ®æŒ‰ç…§æŸä¸ªå­—æ®µå’Œæ¡¶çš„æ•°é‡ï¼Œå¯¹æŒ‡å®šå­—æ®µè¿›è¡Œå–æ¨¡è¿ç®—ï¼Œæ‹†åˆ†æˆå¤šä¸ªå°æ–‡ä»¶æ¥å­˜å‚¨ï¼Œæ¨¡ç›¸åŒçš„å­˜å‚¨åœ¨åŒä¸€ä¸ªå°æ–‡ä»¶ä¸­ï¼Œæé«˜joinä»¥åŠæŠ½æ ·çš„æ•ˆç‡ã€‚</p>
<ul>
<li>é€‚ç”¨æƒ…å½¢<br>æ•°æ®æœ‰ä¸¥é‡çš„æ•°æ®å€¾æ–œï¼Œåˆ†å¸ƒä¸å‡åŒ€ï¼Œä½†æ˜¯ç›¸å¯¹æ¥è¯´æ¯ä¸ªæ¡¶ä¸­çš„æ•°æ®é‡ä¼šæ¯”è¾ƒå¹³å‡ã€‚æ¡¶ä¸æ¡¶ä¹‹é—´åšjoinç­‰æŸ¥è¯¢çš„æ—¶å€™ï¼Œä¼šæœ‰ä¼˜åŒ–ã€‚</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.enforce.bucketing=<span class="literal">true</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp_bu(  </span><br><span class="line">    empno <span class="built_in">int</span>,  </span><br><span class="line">    ename <span class="keyword">string</span>,</span><br><span class="line">    job <span class="keyword">string</span>,  </span><br><span class="line">    mgr <span class="built_in">int</span>,</span><br><span class="line">    hiredate <span class="keyword">string</span>,  </span><br><span class="line">    sal <span class="keyword">double</span>,  </span><br><span class="line">    comm <span class="keyword">double</span>,  </span><br><span class="line">    deptno <span class="built_in">int</span></span><br><span class="line">)</span><br><span class="line">CLUSTERED <span class="keyword">BY</span>(deptno) <span class="keyword">INTO</span> <span class="number">4</span> BUCKETS</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span>  </span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> emp_bu_2 <span class="keyword">select</span> * <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure>
<p>åˆ†æ¡¶è¡¨æ˜¯å¯¹åˆ—å€¼å–å“ˆå¸Œå€¼çš„æ–¹å¼ï¼Œå°†ä¸åŒæ•°æ®æ”¾åˆ°ä¸åŒæ–‡ä»¶ä¸­å­˜å‚¨ï¼Œç”±åˆ—å€¼çš„å“ˆå¸Œå€¼é™¤ä»¥æ¡¶çš„ä¸ªæ•°æ¥å†³å®šæ¯æ¡æ•°æ®åˆ’åˆ†åœ¨å“ªä¸ªæ¡¶ä¸­ã€‚å¯¹äºhiveä¸­æ¯ä¸€ä¸ªè¡¨ã€åˆ†åŒºéƒ½å¯ä»¥è¿›ä¸€æ­¥è¿›è¡Œåˆ†æ¡¶ã€‚</p>
<p>For an int, itâ€™s easy, <code>hash_int(i) == i</code>. ä¾‹å¦‚åŸºäºuser_idè¿›è¡Œåˆ†æ¡¶æ—¶ï¼Œ if user_id were an int, and there were 10 buckets, we would expect all user_idâ€™s that end in 0 to be in bucket 1, all user_idâ€™s that end in a 1 to be in bucket 2, etc. </p>
<p><strong>å»ºè¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> psnbucket( </span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">INT</span>, </span><br><span class="line">    <span class="keyword">name</span> <span class="keyword">STRING</span>, </span><br><span class="line">    age <span class="built_in">INT</span></span><br><span class="line">) </span><br><span class="line">CLUSTERED <span class="keyword">BY</span> (age) <span class="keyword">INTO</span> <span class="number">4</span> BUCKETS </span><br><span class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> <span class="keyword">DELIMITED</span> </span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span>;</span><br></pre></td></tr></table></figure>
<p><strong>æ’å…¥æ•°æ®ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> psnbucket <span class="keyword">select</span> <span class="keyword">id</span>, <span class="keyword">name</span>, age <span class="keyword">from</span> original;</span><br></pre></td></tr></table></figure>
<p><strong>åˆ†æ¡¶è¡¨+åˆ†åŒºè¡¨ï¼š</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> psnbucket_partition( </span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">INT</span>, </span><br><span class="line">    <span class="keyword">name</span> <span class="keyword">STRING</span>, </span><br><span class="line">    age <span class="built_in">INT</span></span><br><span class="line">) </span><br><span class="line">PARTITIONED <span class="keyword">BY</span>(height <span class="keyword">DOUBLE</span>) </span><br><span class="line">CLUSTERED <span class="keyword">BY</span> (age) <span class="keyword">INTO</span> <span class="number">4</span> BUCKETS </span><br><span class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> <span class="keyword">DELIMITED</span> </span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span>;</span><br></pre></td></tr></table></figure>
<hr>
<blockquote>
<p>å‚è€ƒ <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL+BucketedTables" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL+BucketedTables</a></p>
</blockquote>
<p>Bucketed tables are fantastic in that they allow much more efficient <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Sampling" target="_blank" rel="noopener">sampling</a> than do non-bucketed tables, and they may later allow for time saving operations such as mapside joins. However, the bucketing specified at table creation is not enforced when the table is written to, and so it is possible for the tableâ€™s metadata to advertise properties which are not upheld by the tableâ€™s actual layout. This should obviously be avoided. Hereâ€™s how to do it right.</p>
<p>First, <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-Create/Drop/TruncateTable" target="_blank" rel="noopener">table creation</a>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_info_bucketed(user_id <span class="built_in">BIGINT</span>, firstname <span class="keyword">STRING</span>, lastname <span class="keyword">STRING</span>)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">'A bucketed copy of user_info'</span></span><br><span class="line">PARTITIONED <span class="keyword">BY</span>(ds <span class="keyword">STRING</span>)</span><br><span class="line">CLUSTERED <span class="keyword">BY</span>(user_id) <span class="keyword">INTO</span> <span class="number">256</span> BUCKETS;</span><br></pre></td></tr></table></figure>
<p>Note that we specify a column (user_id) to base the bucketing.<br>Then we populate the table</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.enforce.bucketing = <span class="literal">true</span>;  <span class="comment">-- (<span class="doctag">Note:</span> Not needed in Hive 2.x onward)</span></span><br><span class="line">FROM user_id</span><br><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> user_info_bucketed</span><br><span class="line"><span class="keyword">PARTITION</span> (ds=<span class="string">'2009-02-25'</span>)</span><br><span class="line"><span class="keyword">SELECT</span> userid, firstname, lastname <span class="keyword">WHERE</span> ds=<span class="string">'2009-02-25'</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Version 0.x and 1.x only</strong><br>The command <code>set hive.enforce.bucketing = true;</code> allows the correct number of reducers and the cluster by column to be automatically selected based on the table. Otherwise, you would need to set the number of reducers to be the same as the number of buckets as in <code>set mapred.reduce.tasks = 256;</code> and have a <code>CLUSTER BY ...</code> clause in the select.</p>
</blockquote>
<p>What can go wrong? As long as you use the syntax above and <code>set hive.enforce.bucketing = true</code> (for Hive 0.x and 1.x), the tables should be populated properly. Things can go wrong if the bucketing column type is different during the insert and on read, or if you manually cluster by a value thatâ€™s different from the table definition.</p>
<p><strong>Bucketed Sorted Tables</strong></p>
<blockquote>
<p>å‚è€ƒ<br><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-TemporaryTables" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-TemporaryTables</a></p>
</blockquote>
<p>ä¾‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> page_view(viewTime <span class="built_in">INT</span>, userid <span class="built_in">BIGINT</span>,</span><br><span class="line">     page_url <span class="keyword">STRING</span>, referrer_url <span class="keyword">STRING</span>,</span><br><span class="line">     ip <span class="keyword">STRING</span> <span class="keyword">COMMENT</span> <span class="string">'IP Address of the User'</span>)</span><br><span class="line"> <span class="keyword">COMMENT</span> <span class="string">'This is the page view table'</span></span><br><span class="line"> PARTITIONED <span class="keyword">BY</span>(dt <span class="keyword">STRING</span>, country <span class="keyword">STRING</span>)</span><br><span class="line"> CLUSTERED <span class="keyword">BY</span>(userid) SORTED <span class="keyword">BY</span>(viewTime) <span class="keyword">INTO</span> <span class="number">32</span> BUCKETS</span><br><span class="line"> <span class="keyword">ROW</span> <span class="keyword">FORMAT</span> <span class="keyword">DELIMITED</span></span><br><span class="line">   <span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\001'</span></span><br><span class="line">   COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\002'</span></span><br><span class="line">   <span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\003'</span></span><br><span class="line"> <span class="keyword">STORED</span> <span class="keyword">AS</span> SEQUENCEFILE;</span><br></pre></td></tr></table></figure>
<p>In the example above, the page_view table is bucketed (clustered by) userid and within each bucket the data is sorted in increasing order of viewTime. Such an organization allows the user to do efficient sampling on the clustered column - in this case userid. The sorting property allows internal operators to take advantage of the better-known data structure while evaluating queries, also increasing efficiency. MAP KEYS and COLLECTION ITEMS keywords can be used if any of the columns are lists or maps.</p>
<p>CLUSTERED BYå’ŒSORTED BYåˆ›å»ºå‘½ä»¤ä¸ä¼šå½±å“å°†æ•°æ®æ’å…¥è¡¨çš„æ–¹å¼ï¼Œè€Œåªä¼šå½±å“æ•°æ®çš„è¯»å–æ–¹å¼ã€‚ è¿™æ„å‘³ç€ç”¨æˆ·å¿…é¡»æ³¨æ„æ­£ç¡®åœ°æ’å…¥æ•°æ®ï¼Œæ–¹æ³•æ˜¯å°†reducerçš„æ•°é‡æŒ‡å®šä¸ºç­‰äºå­˜å‚¨æ¡¶çš„æ•°é‡ï¼Œå¹¶åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨CLUSTER BYå’ŒSORT BYå‘½ä»¤ã€‚</p>
<h2 id="5-å‘Hiveè¡¨ä¸­æ’å…¥æ•°æ®"><a href="#5-å‘Hiveè¡¨ä¸­æ’å…¥æ•°æ®" class="headerlink" title=" 5. å‘Hiveè¡¨ä¸­æ’å…¥æ•°æ®"></a><span id="jump5"> 5. å‘Hiveè¡¨ä¸­æ’å…¥æ•°æ®</span></h2><h3 id="5-1-Load"><a href="#5-1-Load" class="headerlink" title="5.1 Load"></a>5.1 Load</h3><blockquote>
<p>å‚è€ƒ <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DML#LanguageManualDML-Loadingfilesintotables" target="_blank" rel="noopener">LanguageManual DML - Apache Hive - Apache Software Foundation</a></p>
</blockquote>
<p>Loading files into tables. æ­¤ç§æ–¹å¼é€‚åˆæŠŠæ–‡ä»¶ä¸­çš„æ•°æ®æ’å…¥Hiveè¡¨</p>
<p>Syntax:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> [<span class="keyword">LOCAL</span>] INPATH <span class="string">'filepath'</span> [OVERWRITE] <span class="keyword">INTO</span> <span class="keyword">TABLE</span> tablename [<span class="keyword">PARTITION</span> (partcol1=val1, partcol2=val2 ...)]</span><br><span class="line"> </span><br><span class="line"><span class="keyword">LOAD</span> <span class="keyword">DATA</span> [<span class="keyword">LOCAL</span>] INPATH <span class="string">'filepath'</span> [OVERWRITE] <span class="keyword">INTO</span> <span class="keyword">TABLE</span> tablename [<span class="keyword">PARTITION</span> (partcol1=val1, partcol2=val2 ...)] [INPUTFORMAT <span class="string">'inputformat'</span> SERDE <span class="string">'serde'</span>] (<span class="number">3.0</span> <span class="keyword">or</span> later)</span><br></pre></td></tr></table></figure>
<p>è§£é‡Šï¼š</p>
<p>Hive 3.0ä¹‹å‰çš„åŠ è½½æ“ä½œæ˜¯çº¯å¤åˆ¶/ç§»åŠ¨æ“ä½œï¼Œå°†æ•°æ®æ–‡ä»¶ç§»åŠ¨åˆ°ä¸Hiveè¡¨ç›¸å¯¹åº”çš„ä½ç½®</p>
<ul>
<li><em>filepath</em> å¯ä»¥æ˜¯:<ul>
<li>ç›¸å¯¹è·¯å¾„, å¦‚ project/data1</li>
<li>ç»å¯¹è·¯å¾„, å¦‚ /user/hive/project/data1</li>
<li>a full URI with scheme and (optionally) an authority, such as hdfs://namenode:9000/user/hive/project/data1</li>
<li><strong>å¦‚æœä½¿ç”¨äº†å…³é”®å­—LOCALï¼Œfilepath would be referred from the server where hive beeline is running otherwise it would use the HDFS path.</strong></li>
</ul>
</li>
<li>The target being loaded to can be a table or a partition. If the table is partitioned, then one must specify a specific partition of the table by specifying values for all of the partitioning columns.</li>
<li><em>filepath</em> å¯ä»¥æŒ‡å‘æ–‡ä»¶ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒHiveä¼šå°†æ–‡ä»¶ç§»è‡³è¡¨ä¸­ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯ç›®å½•ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒHiveä¼šå°†ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶ç§»è‡³è¡¨ä¸­ï¼‰ã€‚ In either case, <em>filepath</em> addresses a set of files.</li>
<li>å¦‚æœæŒ‡å®šäº†å…³é”®å­— LOCALï¼Œåˆ™<ul>
<li>loadå‘½ä»¤å°†åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­æŸ¥æ‰¾æ–‡ä»¶è·¯å¾„ã€‚ å¦‚æœæŒ‡å®šçš„æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå®ƒå°†ç›¸å¯¹äºç”¨æˆ·çš„å½“å‰å·¥ä½œç›®å½•è¿›è¡Œè§£é‡Šã€‚ ç”¨æˆ·ä¹Ÿå¯ä»¥ä¸ºæœ¬åœ°æ–‡ä»¶æŒ‡å®šå®Œæ•´çš„URI - for example: <code>file:///user/hive/project/data1</code></li>
<li>the load command will try to copy all the files addressed by <em>filepath</em> to the target filesystem. The target file system is inferred by looking at the location attribute of the table. The copied data files will then be moved to the table.</li>
<li>å¦‚æœè¦è£…è½½çš„æ–‡ä»¶åœ¨æœåŠ¡å™¨ä¸Šï¼Œä½¿ç”¨LOCALï¼›å¦‚æœåœ¨HDFSä¸­ï¼Œä¸ä½¿ç”¨LOCALã€‚</li>
</ul>
</li>
<li>å¦‚æœæœªæŒ‡å®šå…³é”®å­— LOCALï¼Œåˆ™Hiveå°†ä½¿ç”¨æ–‡ä»¶è·¯å¾„çš„å®Œæ•´URIï¼ˆå¦‚æœå·²æŒ‡å®šï¼‰ï¼Œæˆ–å°†åº”ç”¨ä»¥ä¸‹è§„åˆ™ï¼š<ul>
<li>If scheme or authority are not specified, Hive will use the scheme and authority from the hadoop configuration variable <code>fs.default.name</code> that specifies the Namenode URI.</li>
<li>If the path is not absolute, then Hive will interpret it relative to <code>/user/&lt;username&gt;</code></li>
<li>Hive will <em>move</em> the files addressed by <em>filepath</em> into the table (or partition)</li>
</ul>
</li>
<li>å¦‚æœä½¿ç”¨äº† OVERWRITE å…³é”®å­—ï¼Œç›®æ ‡è¡¨ï¼ˆæˆ–åˆ†åŒºï¼‰ä¸­çš„å†…å®¹å°†ä¼šè¢«åˆ æ‰å¹¶è¢«æ›¿æ¢ä¸ºfilepathæŒ‡å‘çš„æ–‡ä»¶ï¼› å¦åˆ™ï¼ŒfilepathæŒ‡å‘çš„æ–‡ä»¶å°†è¢«è¿½åŠ åˆ°è¡¨ä¸­ã€‚</li>
</ul>
<p>ä¾‹ï¼šå°†HDFSä¸­çš„æ–‡ä»¶å¯¼å…¥åˆ†åŒºè¡¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOAD DATA INPATH &apos;/user/kelly/test-ml/20210901predict_result.csv&apos; OVERWRITE INTO TABLE &apos;ads_base.xxxx&apos; partition(dt=20210901)</span><br></pre></td></tr></table></figure>
<h4 id="å®ä¾‹1ï¼šå°†CSVæ–‡ä»¶å¯¼å…¥Hiveè¡¨"><a href="#å®ä¾‹1ï¼šå°†CSVæ–‡ä»¶å¯¼å…¥Hiveè¡¨" class="headerlink" title="å®ä¾‹1ï¼šå°†CSVæ–‡ä»¶å¯¼å…¥Hiveè¡¨"></a>å®ä¾‹1ï¼šå°†CSVæ–‡ä»¶å¯¼å…¥Hiveè¡¨</h4><blockquote>
<p>å‚è€ƒï¼š<a href="https://sparkbyexamples.com/apache-hive/hive-load-csv-file-into-table/" target="_blank" rel="noopener">Hive Load CSV File into Table â€” SparkByExamples</a></p>
</blockquote>
<p>ï¼ˆ1ï¼‰é¦–å…ˆéœ€åˆ›å»ºhiveè¡¨ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> emp.employee (</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span>,</span><br><span class="line">	<span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">	age <span class="built_in">int</span>,</span><br><span class="line">	gender <span class="keyword">string</span> </span><br><span class="line">)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">'Employee Table'</span></span><br><span class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> <span class="keyword">DELIMITED</span></span><br><span class="line"><span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">','</span>;</span><br></pre></td></tr></table></figure>
<p><strong>æ³¨:</strong> ä¸ºäº†å°†csvæ–‡ä»¶å¯¼å…¥Hiveè¡¨, å»ºè¡¨æ—¶éœ€è¦ä½¿ç”¨ <code>ROW FORMAT DELIMITED FIELDS TERMINATED BY &#39;,&#39;</code>ï¼Œå¹¶ä¸”ä¸èƒ½åŠ ä¸Š<code>stored as ORC</code>ï¼Œå¦åˆ™ load æ—¶ä¼šæŠ¥é”™ï¼Œæ–‡ä»¶æ ¼å¼ä¸åŒ¹é…</p>
<p>ï¼ˆ2ï¼‰ä½¿ç”¨ <code>rz</code> å‘½ä»¤å°†ç”µè„‘æœ¬åœ°æ–‡ä»¶ä¸Šä¼ è‡³æœåŠ¡å™¨</p>
<p>æ³¨ï¼šå…ˆå…³é—­æœ¬åœ°æ–‡ä»¶ï¼Œå† <code>rz</code>ï¼Œä¸”æ–‡ä»¶ä¸­ä¸è¦åŒ…å«headerï¼Œå¦åˆ™ä¼šè¢«ä¸€èµ·å¯¼å…¥è¡¨ä¸­</p>
<p>ï¼ˆ3ï¼‰å°†æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ä¸Šä¼ è‡³HDFS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ç™»å½•hive</span><br><span class="line">hive&gt;dfs -put æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶è·¯å¾„ HDFSä¸­çš„æ–‡ä»¶è·¯å¾„</span><br><span class="line">ä¾‹ï¼š</span><br><span class="line">hive&gt;dfs -put /data/test/data.csv /user/kelly/data;</span><br><span class="line">è‹¥ç›®æ ‡è·¯å¾„ä¸å­˜åœ¨ï¼Œéœ€å…ˆæ–°å»ºè·¯å¾„ï¼š</span><br><span class="line">hive&gt;dfs -mkdir /user/kelly/data;</span><br><span class="line">â†‘å…¶ä¸­/user/kellyä¸ºå·²å­˜åœ¨è·¯å¾„</span><br><span class="line">ï¼ˆè‹¥å¤šä¸ªå±‚çº§ç¼ºå¤±ï¼ŒåŠ ä¸Š-på‚æ•°ï¼Œåˆ›å»ºæ‰€æœ‰ç¼ºå¤±ç›®å½•ï¼‰</span><br><span class="line"></span><br><span class="line">å¦‚æœæƒ³é‡è·‘è¦†ç›–ï¼ŒåŠ ä¸Š-få‚æ•°ï¼š</span><br><span class="line">hive&gt;dfs -put -f xxx xxx</span><br></pre></td></tr></table></figure>
<p>ï¼ˆ4ï¼‰å°†HDFSä¸­çš„csvå¯¼å…¥Hiveè¡¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive&gt;LOAD DATA INPATH &apos;/user/kelly/data/data.csv&apos; OVERWRITE INTO TABLE emp.employee;</span><br></pre></td></tr></table></figure>
<p>è‹¥ä½¿ç”¨ <code>overwrite</code>ï¼Œåˆ™ä¼šåˆ æ‰ç›®æ ‡è¡¨é‡Œå·²æœ‰çš„æ•°æ®ï¼Œå¹¶å¯¼å…¥æ–‡ä»¶ä¸­çš„æ•°æ®</p>
<p>ä½¿ç”¨ <code>select * from emp.employee</code> æŸ¥çœ‹æ˜¯å¦å†™å…¥æˆåŠŸã€‚</p>
<p><span style="color:red"><strong>æ³¨ï¼š</strong>å¯¹äºLOAD DATA INAPTHï¼šLOAD åï¼ŒHDFSä¸­çš„æºæ•°æ®ä¼šè¢«åˆ æ‰</span></p>
<p>æ³•äºŒï¼šè·³è¿‡æ­¥éª¤(3)ï¼Œç›´æ¥å°†æœåŠ¡å™¨ï¼ˆå³local filesystemï¼‰ä¸Šçš„csvå¯¼å…¥Hiveè¡¨</p>
<p>Use <code>LOCAL</code> optional clause to load CSV file from the local filesystem into the Hive table without uploading to HDFS.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive&gt;LOAD DATA LOCAL INPATH &apos;/data/test/data.csv&apos; OVERWRITE INTO TABLE emp.employee;</span><br></pre></td></tr></table></figure>
<p><span style="color:red"><strong>æ³¨ï¼š</strong>å¯¹äºLOAD DATA LOCAL INAPTHï¼šlocal file system ä¸­çš„æºæ•°æ®ä¸ä¼šè¢«åˆ æ‰ã€‚</span></p>
<p>å¦ï¼šä½¿ç”¨ <code>partition</code></p>
<p>å¦‚æœç›®æ ‡è¡¨æ˜¯åˆ†åŒºè¡¨ï¼Œä½¿ç”¨ <code>partition</code> å°†æ•°æ®å¯¼å…¥ç‰¹å®šçš„åˆ†åŒºä¸­ã€‚å¹¶ä¸”å¯ä½¿ç”¨ <code>overwrite</code> è¦†ç›–è¯¥åˆ†åŒºï¼ˆåˆ æ‰åŸæœ‰çš„æ•°æ®å¹¶è£…è½½ç°åœ¨çš„æ•°æ®ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive&gt;LOAD DATA INPATH &apos;/user/kelly/data/data.csv&apos; OVERWRITE INTO TABLE emp.employee PARTITION(date=2020);</span><br></pre></td></tr></table></figure>
<h4 id="å®ä¾‹2ï¼šå°†hiveè¡¨å†…å®¹å¯¼å‡ºä¸ºcsv"><a href="#å®ä¾‹2ï¼šå°†hiveè¡¨å†…å®¹å¯¼å‡ºä¸ºcsv" class="headerlink" title="å®ä¾‹2ï¼šå°†hiveè¡¨å†…å®¹å¯¼å‡ºä¸ºcsv"></a>å®ä¾‹2ï¼šå°†hiveè¡¨å†…å®¹å¯¼å‡ºä¸ºcsv</h4><p>hiveè¡¨çš„å†…å®¹å®é™…æ˜¯å­˜åœ¨hdfsä¸Šçš„ï¼Œå¯ä»¥ç›´æ¥å¯¼å‡ºåˆ°æœåŠ¡å™¨æœ¬åœ°ï¼š</p>
<p>read_data.sh</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">local_path=<span class="string">'./docs/predict_data.csv'</span></span><br><span class="line"></span><br><span class="line">hive -e <span class="string">"insert overwrite local directory './docs/predict_data_dir/'</span></span><br><span class="line"><span class="string">ROW FORMAT DELIMITED FIELDS TERMINATED BY '\u0000'</span></span><br><span class="line"><span class="string">select * from xx_db.xx_table</span></span><br><span class="line"><span class="string">where dt=xxx;</span></span><br><span class="line"><span class="string">"</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># â†‘å¦‚æœæ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œä¼šè¢«åˆ†æˆå‡ ä¸ªæ–‡ä»¶å»ä¿å­˜ï¼Œæ–‡ä»¶åå½¢å¦‚000000_0ï¼Œ000001_0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœéœ€è¦è¡¨å¤´ï¼š</span></span><br><span class="line"><span class="comment"># æ³•ä¸€ï¼šä»hiveè·å–</span></span><br><span class="line"><span class="comment">#hive  -e 'SET hive.cli.print.header=true; SELECT * FROM xx_db.xx_table LIMIT 0' &gt; ./docs/predict_data.csv </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># â†‘æ‰§è¡Œå®Œåï¼Œæœ€å¥½æ£€æŸ¥ä¸€ä¸‹csvçš„è¡¨å¤´æ˜¯å¦æ­£ç¡®(å¯èƒ½ä¸€äº›æ—¥å¿—å†…å®¹ä¹Ÿä¼šè¢«å†™è¿›å»)ï¼Œæœ€å¥½é‡‡ç”¨æ³•äºŒ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³•äºŒï¼šæ‰‹åŠ¨æŠŠè¡¨å¤´å­˜å…¥æ–‡ä»¶ï¼Œå†ä»æ–‡ä»¶è¯»å–å­˜å…¥csv</span></span><br><span class="line">cat ./docs/final_features.txt | sed <span class="string">'s/,/\t/g'</span>&gt; <span class="variable">$local_path</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†åˆšåˆšä¿å­˜çš„hiveè¡¨å†…å®¹å†™å…¥csv</span></span><br><span class="line">cat ./docs/predict_data_dir/* &gt;&gt; <span class="variable">$local_path</span>  <span class="comment">#æŠŠ000000_0ï¼Œ000001_0è¿™æ ·çš„æ–‡ä»¶é€šè¿‡è¿½åŠ çš„æ–¹å¼ï¼Œå†™å…¥æœ€ç»ˆçš„csvæ–‡ä»¶ä¸­</span></span><br><span class="line">sed -i <span class="string">'s/,/-/g'</span> <span class="variable">$local_path</span>       <span class="comment"># æœ‰å­—æ®µä¸­å«æœ‰é€—å·ï¼Œå°†å…¶æ›¿æ¢ä¸º'-'</span></span><br><span class="line">sed -i <span class="string">'s/[\t]/,/g'</span> <span class="variable">$local_path</span></span><br><span class="line">sed -i <span class="string">'s/\x00/,/g'</span> <span class="variable">$local_path</span></span><br></pre></td></tr></table></figure>
<p>å¯æŒ‡å®šåˆ†éš”ç¬¦ä¸ºé€—å·ï¼š<code>ROW FORMAT DELIMITED FIELDS TERMINATED BY &#39;,&#39;</code>ï¼Œä½†è‹¥å­—æ®µä¸­çš„å†…å®¹å«æœ‰é€—å·ï¼Œåˆ™éœ€ä½¿ç”¨å…¶ä»–åˆ†éš”ç¬¦ï¼Œä¾‹å¦‚ <code>&#39;\u0000&#39;</code>ã€‚</p>
<p>æ›´å¤šå…³äºåˆ†éš”ç¬¦çš„å†…å®¹è§  <a href="https://blog.csdn.net/lvtula/article/details/89447929" target="_blank" rel="noopener">Hiveåº”ç”¨ï¼šé€‰å–åˆ†éš”ç¬¦</a></p>
<p>æ³¨ï¼š<code>sed s/,/\t/g</code> æ„æ€æ˜¯å°†æ‰€æœ‰é€—å·æ›¿æ¢ä¸º\tï¼Œé€‰é¡¹ <code>i</code> ä½¿ sed ä¿®æ”¹æ–‡ä»¶</p>
<h3 id="5-2-Insert"><a href="#5-2-Insert" class="headerlink" title="5.2 Insert"></a>5.2 Insert</h3><h4 id="5-2-1-INSERT-INTO-OVERWRITE-TABLE-SELECT"><a href="#5-2-1-INSERT-INTO-OVERWRITE-TABLE-SELECT" class="headerlink" title="5.2.1 INSERT INTO/OVERWRITE TABLE SELECT"></a><span id="jump5.2.1">5.2.1 INSERT INTO/OVERWRITE TABLE SELECT</span></h4><blockquote>
<p>å‚è€ƒ <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DML#LanguageManualDML-InsertingdataintoHiveTablesfromqueries" target="_blank" rel="noopener">LanguageManual DML - Apache Hive - Apache Software Foundation</a></p>
</blockquote>
<p>Inserting data into Hive Tables from queries. æ­¤ç§æ–¹å¼é€‚åˆæŠŠHiveè¡¨é‡Œçš„æ•°æ®æ’å…¥å¦ä¸€å¼ Hiveè¡¨ã€‚</p>
<p>Syntax</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Standard syntax:</span><br><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> tablename1 [<span class="keyword">PARTITION</span> (partcol1=val1, partcol2=val2 ...) [<span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>]] <span class="keyword">SELECT</span> select_statement1 <span class="keyword">FROM</span> from_statement;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> tablename1 [<span class="keyword">PARTITION</span> (partcol1=val1, partcol2=val2 ...)] <span class="keyword">SELECT</span> select_statement1 <span class="keyword">FROM</span> from_statement;</span><br><span class="line"> </span><br><span class="line">Hive extension (multiple inserts):</span><br><span class="line">FROM from_statement</span><br><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> tablename1 [<span class="keyword">PARTITION</span> (partcol1=val1, partcol2=val2 ...) [<span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>]] <span class="keyword">SELECT</span> select_statement1</span><br><span class="line">[<span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> tablename2 [<span class="keyword">PARTITION</span> ... [<span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>]] <span class="keyword">SELECT</span> select_statement2]</span><br><span class="line">[<span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> tablename2 [<span class="keyword">PARTITION</span> ...] <span class="keyword">SELECT</span> select_statement2] ...;</span><br><span class="line">FROM from_statement</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> tablename1 [<span class="keyword">PARTITION</span> (partcol1=val1, partcol2=val2 ...)] <span class="keyword">SELECT</span> select_statement1</span><br><span class="line">[<span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> tablename2 [<span class="keyword">PARTITION</span> ...] <span class="keyword">SELECT</span> select_statement2]</span><br><span class="line">[<span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> tablename2 [<span class="keyword">PARTITION</span> ... [<span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>]] <span class="keyword">SELECT</span> select_statement2] ...;</span><br><span class="line"> </span><br><span class="line">Hive extension (dynamic partition inserts):</span><br><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> tablename <span class="keyword">PARTITION</span> (partcol1[=val1], partcol2[=val2] ...) <span class="keyword">SELECT</span> select_statement <span class="keyword">FROM</span> from_statement;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> tablename <span class="keyword">PARTITION</span> (partcol1[=val1], partcol2[=val2] ...) <span class="keyword">SELECT</span> select_statement <span class="keyword">FROM</span> from_statement;</span><br></pre></td></tr></table></figure>
<p>è§£é‡Šï¼š</p>
<ul>
<li><code>INSERT OVERWRITE</code> å°†<span style="color:red">è¦†ç›–è¡¨æˆ–åˆ†åŒºä¸­çš„ä»»ä½•ç°æœ‰æ•°æ®</span><ul>
<li>unless <code>IF NOT EXISTS</code> is provided for a partition (as of Hive <a href="https://issues.apache.org/jira/browse/HIVE-2612" target="_blank" rel="noopener">0.9.0</a>).</li>
<li>As of Hive 2.3.0 (<a href="https://issues.apache.org/jira/browse/HIVE-15880" target="_blank" rel="noopener">HIVE-15880</a>), if the table has <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-listTableProperties" target="_blank" rel="noopener">TBLPROPERTIES</a> (â€œauto.purgeâ€=â€trueâ€) the previous data of the table is not moved to Trash when INSERT OVERWRITE query is run against the table. This functionality is applicable only for managed tables (see <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-ManagedandExternalTables" target="_blank" rel="noopener">managed tables</a>) and is turned off when â€œauto.purgeâ€ property is unset or set to false.</li>
</ul>
</li>
<li><code>INSERT INTO</code> å°†<span style="color:red">è¿½åŠ åˆ°è¡¨æˆ–åˆ†åŒºï¼Œä¿æŒç°æœ‰æ•°æ®ä¸å˜</span><ul>
<li>As of Hive <a href="https://issues.apache.org/jira/browse/HIVE-6406" target="_blank" rel="noopener">0.13.0</a>, a table can be made <strong>immutable</strong> by creating it with <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-CreateTable" target="_blank" rel="noopener">TBLPROPERTIES (â€œimmutableâ€=â€trueâ€)</a>. The default is â€œimmutableâ€=â€falseâ€.<br>å¦‚æœè¡¨ä¸­å·²ç»å­˜åœ¨ä»»ä½•æ•°æ®ï¼Œåˆ™ä¸å…è®¸åœ¨ä¸å¯å˜è¡¨ä¸­æ‰§è¡ŒINSERT INTOè¡Œä¸ºï¼Œä½†å¦‚æœä¸å¯å˜è¡¨ä¸ºç©ºï¼Œåˆ™æ’å…¥INTOä»ç„¶å¯ä»¥å·¥ä½œã€‚ INSERT OVERWRITE çš„è¡Œä¸ºä¸å—â€œä¸å¯å˜â€è¡¨å±æ€§çš„å½±å“ã€‚<br>ä¸å¯å˜è¡¨å¯ä»¥é˜²æ­¢ç”±äºè„šæœ¬é”™è¯¯åœ°å¤šæ¬¡è¿è¡Œè€Œå°†æ•°æ®åŠ è½½åˆ°è¡¨ä¸­çš„æ„å¤–æ›´æ–°ã€‚The first insert into an immutable table succeeds and successive inserts fail, resulting in only one set of data in the table, instead of silently succeeding with multiple copies of the data in the table.</li>
</ul>
</li>
<li>å¯ä»¥å¯¹è¡¨æˆ–åˆ†åŒºè¿›è¡Œæ’å…¥ã€‚å¦‚æœè¡¨æ˜¯åˆ†åŒºè¡¨ï¼Œåˆ™å¿…é¡»é€šè¿‡æŒ‡å®šæ‰€æœ‰åˆ†åŒºåˆ—çš„å€¼æ¥æŒ‡å®šä¸€ä¸ªç‰¹å®šçš„åˆ†åŒº. If <a href="https://cwiki.apache.org/confluence/display/Hive/Configuration+Properties#ConfigurationProperties-hive.typecheck.on.insert" target="_blank" rel="noopener">hive.typecheck.on.insert</a> is set to true, these values are validated, converted and normalized to conform to their column types (Hive <a href="https://issues.apache.org/jira/browse/HIVE-5297" target="_blank" rel="noopener">0.12.0</a> onward). </li>
<li>å¯ä»¥åœ¨åŒä¸€æŸ¥è¯¢ä¸­æŒ‡å®šå¤šä¸ªæ’å…¥å­å¥ï¼ˆä¹Ÿç§°ä¸ºå¤šè¡¨æ’å…¥ï¼‰ã€‚</li>
<li>The output of each of the select statements is written to the chosen table (or partition). Currently the OVERWRITE keyword is mandatory and implies that the contents of the chosen table or partition are replaced with the output of corresponding select statement.</li>
<li>The output format and serialization class is determined by the tableâ€™s metadata (as specified via DDL commands on the table).</li>
<li>As of Hive <a href="https://issues.apache.org/jira/browse/HIVE-9353" target="_blank" rel="noopener">1.1.0</a> the TABLE keyword is optional.</li>
<li>As of Hive <a href="https://issues.apache.org/jira/browse/HIVE-9481" target="_blank" rel="noopener">1.2.0</a> each INSERT INTO T can take a column list like INSERT INTO T (z, x, c1).  See Description of <a href="https://issues.apache.org/jira/browse/HIVE-9481" target="_blank" rel="noopener">HIVE-9481</a> for examples.</li>
</ul>
<p><strong>Notes</strong></p>
<ul>
<li>Multi Table Inserts minimize the number of data scans required. Hive can insert data into multiple tables by scanning the input data just once (and applying different query operators to the input data). å¤šè¡¨æ’å…¥å¯æœ€å¤§ç¨‹åº¦åœ°å‡å°‘æ‰€éœ€çš„æ•°æ®æ‰«ææ¬¡æ•°ã€‚ Hiveå¯ä»¥é€šè¿‡åªæ‰«æä¸€æ¬¡è¾“å…¥æ•°æ®ï¼ˆå¹¶åº”ç”¨ä¸åŒçš„æŸ¥è¯¢è¿ç®—ç¬¦åˆ°è¾“å…¥æ•°æ®ï¼‰æ¥å°†æ•°æ®æ’å…¥åˆ°å¤šä¸ªè¡¨ä¸­ã€‚</li>
<li>Starting with <a href="https://issues.apache.org/jira/browse/HIVE-1180" target="_blank" rel="noopener">Hive 0.13.0</a>, the select statement can include one or more common table expressions (CTEs) as shown in the <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Select#LanguageManualSelect-SelectSyntax" target="_blank" rel="noopener">SELECT syntax</a>. For an example, see <a href="https://cwiki.apache.org/confluence/display/Hive/Common+Table+Expression#CommonTableExpression-CTEinViews,CTAS,andInsertStatements" target="_blank" rel="noopener">Common Table Expression</a>.</li>
</ul>
<p>ä¾‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> rest <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tableA;</span><br><span class="line">		</span><br><span class="line">ä¹ æƒ¯å†™æ³• fromæå‰  å‡å°‘SQLä»£ç çš„å†—ä½™</span><br><span class="line">from day_hour_table</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> rest </span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) ;</span><br></pre></td></tr></table></figure>
<h4 id="5-2-2-INSERT-INTO-â€¦-VALUES"><a href="#5-2-2-INSERT-INTO-â€¦-VALUES" class="headerlink" title="5.2.2 INSERT INTO â€¦ VALUES"></a>5.2.2 INSERT INTO â€¦ VALUES</h4><blockquote>
<p>å‚è€ƒ <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DML#LanguageManualDML-InsertingvaluesintotablesfromSQL" target="_blank" rel="noopener">LanguageManual DML - Apache Hive - Apache Software Foundation</a></p>
</blockquote>
<p>Inserting values into tables from SQL. æ­¤ç§æ–¹å¼é€‚åˆå°†å…·ä½“æ•°å€¼ï¼ˆå°‘é‡ï¼‰æ’å…¥åˆ°Hiveè¡¨ã€‚</p>
<p>Syntaxï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Standard Syntax:</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> tablename [<span class="keyword">PARTITION</span> (partcol1[=val1], partcol2[=val2] ...)] <span class="keyword">VALUES</span> values_row [, values_row ...]</span><br><span class="line">  </span><br><span class="line"><span class="keyword">Where</span> values_row <span class="keyword">is</span>:</span><br><span class="line">( <span class="keyword">value</span> [, <span class="keyword">value</span> ...] )</span><br><span class="line"><span class="keyword">where</span> a <span class="keyword">value</span> <span class="keyword">is</span> either <span class="literal">null</span> <span class="keyword">or</span> <span class="keyword">any</span> valid <span class="keyword">SQL</span> literal</span><br></pre></td></tr></table></figure>
<p>è§£é‡Šï¼š</p>
<ul>
<li>VALUES å­å¥ä¸­åˆ—å‡ºçš„æ¯ä¸€è¡Œéƒ½ä¼šè¢«æ’å…¥åˆ°è¡¨ä¸­ï¼ˆæ’å…¥å¤šè¡Œæ•°æ®å¯ä»¥å†™åˆ°ä¸€ä¸ªinsert intoè¯­å¥ä¸­ï¼‰</li>
<li>è¡¨ä¸­çš„æ¯ä¸€åˆ—éƒ½éœ€æä¾›éœ€è¦æ’å…¥çš„å€¼ã€‚å…è®¸ç”¨æˆ·åªå‘æŸäº›åˆ—æ’å…¥å€¼çš„æ ‡å‡†SQLè¯­æ³•ç›®å‰è¿˜ä¸æ”¯æŒã€‚ä¸ºäº†æ¨¡æ‹Ÿæ ‡å‡†SQLï¼Œç”¨æˆ·ä¸å¸Œæœ›èµ‹å€¼çš„åˆ—å¯ä»¥æä¾›nullã€‚</li>
<li>ä½¿ç”¨ INSERT INTO â€¦ VALUES è¯­å¥ä¸æ”¯æŒ complex datatypes (array, map, struct, union)</li>
</ul>
<p>ä¾‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> students (<span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>), age <span class="built_in">INT</span>, gpa <span class="built_in">DECIMAL</span>(<span class="number">3</span>, <span class="number">2</span>))</span><br><span class="line">  CLUSTERED <span class="keyword">BY</span> (age) <span class="keyword">INTO</span> <span class="number">2</span> BUCKETS <span class="keyword">STORED</span> <span class="keyword">AS</span> ORC;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> students</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="string">'fred flintstone'</span>, <span class="number">35</span>, <span class="number">1.28</span>), (<span class="string">'barney rubble'</span>, <span class="number">32</span>, <span class="number">2.32</span>);</span><br><span class="line">  </span><br><span class="line"> </span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> pageviews (userid <span class="built_in">VARCHAR</span>(<span class="number">64</span>), <span class="keyword">link</span> <span class="keyword">STRING</span>, came_from <span class="keyword">STRING</span>)</span><br><span class="line">  PARTITIONED <span class="keyword">BY</span> (datestamp <span class="keyword">STRING</span>) CLUSTERED <span class="keyword">BY</span> (userid) <span class="keyword">INTO</span> <span class="number">256</span> BUCKETS <span class="keyword">STORED</span> <span class="keyword">AS</span> ORC;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> pageviews <span class="keyword">PARTITION</span> (datestamp = <span class="string">'2014-09-23'</span>)</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="string">'jsmith'</span>, <span class="string">'mail.com'</span>, <span class="string">'sports.com'</span>), (<span class="string">'jdoe'</span>, <span class="string">'mail.com'</span>, <span class="literal">null</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> pageviews <span class="keyword">PARTITION</span> (datestamp)</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="string">'tjohnson'</span>, <span class="string">'sports.com'</span>, <span class="string">'finance.com'</span>, <span class="string">'2014-09-23'</span>), (<span class="string">'tlee'</span>, <span class="string">'finance.com'</span>, <span class="literal">null</span>, <span class="string">'2014-09-21'</span>);</span><br><span class="line">  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> pageviews</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="string">'tjohnson'</span>, <span class="string">'sports.com'</span>, <span class="string">'finance.com'</span>, <span class="string">'2014-09-23'</span>), (<span class="string">'tlee'</span>, <span class="string">'finance.com'</span>, <span class="literal">null</span>, <span class="string">'2014-09-21'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="6-å‘½ä»¤"><a href="#6-å‘½ä»¤" class="headerlink" title="6. å‘½ä»¤"></a><span id="jump6">6. å‘½ä»¤</span></h2><p>è¿™é‡Œçš„å‘½ä»¤æŒ‡ésqlè¯­å¥ï¼Œä¾‹å¦‚è®¾ç½®å±æ€§æˆ–æ·»åŠ èµ„æºã€‚å®ƒä»¬å¯ä»¥åœ¨HiveQLè„šæœ¬ä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨CLIæˆ–Beelineä¸­ä½¿ç”¨ã€‚</p>
<p>å¦‚ä½•æŸ¥çœ‹hiveç‰ˆæœ¬ï¼š</p>
<p>åœ¨å®‰è£…äº†hiveçš„æœåŠ¡å™¨ä¸Šè¿è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive --version</span><br></pre></td></tr></table></figure>
<p>Hive shell ä¸­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">hive&gt;quit;</span><br><span class="line">é€€å‡ºinteractive shellï¼ˆæˆ–ä½¿ç”¨ctrl + cï¼‰</span><br><span class="line"></span><br><span class="line">! &lt;command&gt;</span><br><span class="line">Executes a shell command from the Hive shell.</span><br><span class="line">ä¾‹å¦‚ï¼š</span><br><span class="line">hive&gt;!ls;</span><br><span class="line">ï¼ˆæŸ¥çœ‹è¿›å…¥hive shellå‰æ‰€åœ¨è·¯å¾„ä¸‹çš„æ–‡ä»¶ï¼‰</span><br><span class="line"></span><br><span class="line">dfs &lt;dfs command&gt;</span><br><span class="line">Executes a dfs command from the Hive shell.</span><br><span class="line">ä¾‹å¦‚ï¼š</span><br><span class="line">hive&gt;dfs -ls /user;</span><br><span class="line">ï¼ˆæŸ¥çœ‹hdfsä¸­/userç›®å½•ä¸‹çš„æ–‡ä»¶ï¼‰</span><br></pre></td></tr></table></figure>
<p>Linuxå‘½ä»¤è¡Œä¸­ï¼š</p>
<blockquote>
<p>å‚è€ƒ <a href="https://blog.csdn.net/weixin_42073408/article/details/120483485" target="_blank" rel="noopener">https://blog.csdn.net/weixin_42073408/article/details/120483485</a></p>
</blockquote>
<p>ä¸è¿›å…¥ hive shell , ç›´æ¥åœ¨linuxç•Œé¢æ‰§è¡Œhiveå‘½ä»¤,å¯ä½¿ç”¨ <strong>-e</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$hive -e &apos;select * from test_table&apos;</span><br></pre></td></tr></table></figure>
<p>å¢åŠ  <code>-S</code> é€‰é¡¹å¯ä»¥å¼€å¯é™é»˜æ¨¡å¼ï¼Œè¿™æ ·å¯ä»¥è¾“å‡ºç»“æœä¸­å»æ‰â€˜OKâ€™,â€™Time Takenâ€™ç­‰è¡Œï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$hive -S -e &apos;select * from test_table&apos;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ <code>-f</code> æ‰§è¡Œæ–‡ä»¶ä¸­çš„æŸ¥è¯¢è¯­å¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$hive -f /tem/myquery.hql</span><br></pre></td></tr></table></figure>
<p>åœ¨ hive shell ä¸­å¯ä»¥ä½¿ç”¨ <code>source</code> å‘½ä»¤æ‰§è¡Œæ–‡ä»¶ä¸­çš„æŸ¥è¯¢è¯­å¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive&gt;source /tem/myquery.hql</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Hadoop/" rel="tag"># Hadoop</a>
          
            <a href="/tags/Hive/" rel="tag"># Hive</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/01/12/ç¬”è¯•çŸ¥è¯†ç‚¹/" rel="next" title="ç¬”è¯•çŸ¥è¯†ç‚¹">
                <i class="fa fa-chevron-left"></i> ç¬”è¯•çŸ¥è¯†ç‚¹
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/01/13/è§†å›¾View/" rel="prev" title="è§†å›¾View">
                è§†å›¾View <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="qypx">
            
              <p class="site-author-name" itemprop="name">qypx</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">128</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">57</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/qypx" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          


          
          

          
          

          


          <!-- æ–°å¢çš„å†…å®¹ -->
          <!-- require APlayer -->
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
          <script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
          <!-- require MetingJS -->
          <script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

          <meting-js server="netease" type="playlist" id="4870130923" list-folded="true" order="random">
          </meting-js>
          <!-- æ–°å¢çš„å†…å®¹end -->

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-ä»€ä¹ˆæ˜¯Hiveï¼Ÿ"><span class="nav-text">1.ä»€ä¹ˆæ˜¯Hiveï¼Ÿ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Hiveçš„åŸç†"><span class="nav-text">2.Hiveçš„åŸç†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Hive-çš„ä½“ç³»ç»“æ„"><span class="nav-text">2.1 Hive çš„ä½“ç³»ç»“æ„</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Hiveå»ºè¡¨è¯­å¥"><span class="nav-text">3.Hiveå»ºè¡¨è¯­å¥</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-æ³•ä¸€ï¼šç›´æ¥å»ºè¡¨æ³•"><span class="nav-text">3.1 æ³•ä¸€ï¼šç›´æ¥å»ºè¡¨æ³•</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-row-format"><span class="nav-text">3.1.1 row format</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-file-formatï¼ˆHDFSæ–‡ä»¶å­˜æ”¾çš„æ ¼å¼ï¼‰"><span class="nav-text">3.1.2 file formatï¼ˆHDFSæ–‡ä»¶å­˜æ”¾çš„æ ¼å¼ï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#3-1-2-1-TEXTFILE"><span class="nav-text">3.1.2.1 TEXTFILE</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ç¤ºä¾‹1ï¼šä»¥TABä¸ºåˆ—é—´åˆ†éš”ç¬¦çš„æ–‡æœ¬æ–‡ä»¶"><span class="nav-text">ç¤ºä¾‹1ï¼šä»¥TABä¸ºåˆ—é—´åˆ†éš”ç¬¦çš„æ–‡æœ¬æ–‡ä»¶</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ç¤ºä¾‹2ï¼šJSONæ ¼å¼çš„æ•°æ®æ–‡ä»¶"><span class="nav-text">ç¤ºä¾‹2ï¼šJSONæ ¼å¼çš„æ•°æ®æ–‡ä»¶</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ç¤ºä¾‹3ï¼šcomplex-jsonè¡¨ä¸­å«æœ‰ç»“æ„ç±»å‹åµŒå¥—å’Œç»“æ„ã€æ•°ç»„ã€ç»“æ„ä¸‰å±‚åµŒå¥—ã€‚"><span class="nav-text">ç¤ºä¾‹3ï¼šcomplex_jsonè¡¨ä¸­å«æœ‰ç»“æ„ç±»å‹åµŒå¥—å’Œç»“æ„ã€æ•°ç»„ã€ç»“æ„ä¸‰å±‚åµŒå¥—ã€‚</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-1-2-2-SEQUENCEFILE"><span class="nav-text">3.1.2.2  SEQUENCEFILE</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ç¤ºä¾‹"><span class="nav-text">ç¤ºä¾‹</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-1-2-3-RCFILE"><span class="nav-text">3.1.2.3 RCFILE</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ç¤ºä¾‹-1"><span class="nav-text">ç¤ºä¾‹</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-1-2-4-ORCFILE"><span class="nav-text">3.1.2.4 ORCFILE</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ç¤ºä¾‹-2"><span class="nav-text">ç¤ºä¾‹</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-1-2-5-æ€»ç»“"><span class="nav-text">3.1.2.5 æ€»ç»“</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-3-ä¾‹å­ï¼šåˆ›å»ºå†…éƒ¨è¡¨"><span class="nav-text">3.1.3 ä¾‹å­ï¼šåˆ›å»ºå†…éƒ¨è¡¨</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-åˆ›å»ºè¡¨"><span class="nav-text">1. åˆ›å»ºè¡¨</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-æŸ¥çœ‹è¡¨çš„æè¿°"><span class="nav-text">2.æŸ¥çœ‹è¡¨çš„æè¿°</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-è£…è½½æ•°æ®"><span class="nav-text">3. è£…è½½æ•°æ®</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#a-å‘éåˆ†åŒºè¡¨ä¸­è£…è½½æ•°æ®"><span class="nav-text">a. å‘éåˆ†åŒºè¡¨ä¸­è£…è½½æ•°æ®</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#b-å‘åˆ†åŒºè¡¨ä¸­è£…è½½æ•°æ®"><span class="nav-text">b. å‘åˆ†åŒºè¡¨ä¸­è£…è½½æ•°æ®</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-æŸ¥çœ‹æ–‡ä»¶ä½ç½®"><span class="nav-text">4. æŸ¥çœ‹æ–‡ä»¶ä½ç½®</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-åˆ é™¤å†…éƒ¨è¡¨"><span class="nav-text">5. åˆ é™¤å†…éƒ¨è¡¨</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-4-ä¾‹å­ï¼šåˆ›å»ºå¤–éƒ¨è¡¨"><span class="nav-text">3.1.4 ä¾‹å­ï¼šåˆ›å»ºå¤–éƒ¨è¡¨</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-åˆ›å»ºè¡¨-1"><span class="nav-text">1. åˆ›å»ºè¡¨</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-è£…è½½æ•°æ®"><span class="nav-text">2. è£…è½½æ•°æ®</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-æŸ¥çœ‹æ–‡ä»¶ä½ç½®"><span class="nav-text">3. æŸ¥çœ‹æ–‡ä»¶ä½ç½®</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-åˆ é™¤å¤–éƒ¨è¡¨"><span class="nav-text">4. åˆ é™¤å¤–éƒ¨è¡¨</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-æ³•äºŒï¼šæŸ¥è¯¢å»ºè¡¨æ³•ï¼ˆCreate-Table-As-Select-CTAS-ï¼‰"><span class="nav-text">3.2 æ³•äºŒï¼šæŸ¥è¯¢å»ºè¡¨æ³•ï¼ˆCreate Table As Select (CTAS)ï¼‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-æ³•ä¸‰ï¼šlikeå»ºè¡¨æ³•"><span class="nav-text">3.3 æ³•ä¸‰ï¼šlikeå»ºè¡¨æ³•</span></a></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Hiveä¸­è¡¨çš„ç±»å‹"><span class="nav-text">4. Hiveä¸­è¡¨çš„ç±»å‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-å†…éƒ¨è¡¨ä¸å¤–éƒ¨è¡¨"><span class="nav-text">4.1 å†…éƒ¨è¡¨ä¸å¤–éƒ¨è¡¨</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-1-Feature-comparison"><span class="nav-text">4.1.1 Feature comparison</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-2-å†…éƒ¨è¡¨ï¼ˆManaged-Tableï¼‰"><span class="nav-text">4.1.2 å†…éƒ¨è¡¨ï¼ˆManaged Tableï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-3-å¤–éƒ¨è¡¨ï¼ˆExternal-Tableï¼‰"><span class="nav-text">4.1.3 å¤–éƒ¨è¡¨ï¼ˆExternal Tableï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-4-å†…éƒ¨è¡¨ä¸å¤–éƒ¨è¡¨çš„åŒºåˆ«"><span class="nav-text">4.1.4 å†…éƒ¨è¡¨ä¸å¤–éƒ¨è¡¨çš„åŒºåˆ«</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-ä¸´æ—¶è¡¨ï¼ˆTemporary-Tableï¼‰"><span class="nav-text">4.2 ä¸´æ—¶è¡¨ï¼ˆTemporary Tableï¼‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-åˆ†åŒºè¡¨ï¼ˆPartitioned-Tableï¼‰"><span class="nav-text">4.3 åˆ†åŒºè¡¨ï¼ˆPartitioned Tableï¼‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-åˆ†æ¡¶è¡¨ï¼ˆBucked-Tablesï¼‰"><span class="nav-text">4.4 åˆ†æ¡¶è¡¨ï¼ˆBucked Tablesï¼‰</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-å‘Hiveè¡¨ä¸­æ’å…¥æ•°æ®"><span class="nav-text"> 5. å‘Hiveè¡¨ä¸­æ’å…¥æ•°æ®</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-Load"><span class="nav-text">5.1 Load</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#å®ä¾‹1ï¼šå°†CSVæ–‡ä»¶å¯¼å…¥Hiveè¡¨"><span class="nav-text">å®ä¾‹1ï¼šå°†CSVæ–‡ä»¶å¯¼å…¥Hiveè¡¨</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å®ä¾‹2ï¼šå°†hiveè¡¨å†…å®¹å¯¼å‡ºä¸ºcsv"><span class="nav-text">å®ä¾‹2ï¼šå°†hiveè¡¨å†…å®¹å¯¼å‡ºä¸ºcsv</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-Insert"><span class="nav-text">5.2 Insert</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-1-INSERT-INTO-OVERWRITE-TABLE-SELECT"><span class="nav-text">5.2.1 INSERT INTO/OVERWRITE TABLE SELECT</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-2-INSERT-INTO-â€¦-VALUES"><span class="nav-text">5.2.2 INSERT INTO â€¦ VALUES</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-å‘½ä»¤"><span class="nav-text">6. å‘½ä»¤</span></a></li></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 &mdash; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">qypx</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  


  

  



<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"left"},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
